---
title: "Assessment and implementation of resource road simulation methods for projection of cumulative effects of disturbance on wildlife"
author:
  - name: Josie Hughes
    email: josie.hughes@ec.gc.ca
    institute: [ECCC]
    correspondence: true
  - name: Sarah Endicott
    email: sarah.endicott@ec.gc.ca
    institute: [ECCC]
    correspondence: false
  - name: David Lapins
    email: david.lapins@pc.gc.ca
    institute: [ECCC]
    correspondence: false
  - name: Kyle Lochhead
    email: Kyle.Lochhead@gov.bc.ca
    institute: [FLNR]
    correspondence: false
  - name: Gregory Paradis
    email: gregory.paradis@ubc.ca
    institute: [UBC]
    correspondence: false

institute:
  - ECCC: Environment and Climate Change Canada 
  - FLNR: British Columbia Ministry of Forests 
  - UBC: University of British Columbia 
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      number_sections: no
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
bibliography: Roads.bib
csl: "../templates/journal-of-forest-ecology-and-management.csl" # Insert path for the bib-style
abstract: |
  Text of abstract
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
editor_options: 
  chunk_output_type: inline
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

<!-- With the following code you can access and display values from the yml header above. -->

<!-- Link to data here: https://drive.google.com/file/d/179lw6MPK4l3xGmded9kofzJkB6VlJVb9/view?usp=sharing -->

Keywords: `r rmarkdown::metadata$keywords`

Highlights: `r rmarkdown::metadata$highlights`

<!-- The following code chunk defines some general settings how code chunks should behave. -->

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  dpi = 300
)
```

<!-- The actual document text starts here: -->

# Introduction

The impacts of roads on wildlife are complex and varied. Mortality risk and stress on or near roads can be elevated due to vehicle collisions, hunting pressure, predation, noise and other stressors, but roads can also provide food, facilitate movement, and provide refuge [@hill_review_2021; @trombulak_review_2000; @fahrig_effects_2009].\
In Canadian forests, there is ample evidence of linear features attracting predators such as bears (*Ursus americanus*, *Ursus arctos*) and wolves (*Canis lupus*) seeking food or easy movement, while repelling prey such as woodland caribou (*Rangifer tarandus caribou*) and moose (*Alces americanus*) [@dickie_corridors_2020; @polfus_identifying_2011; @mumma_predation_2018; @beauchesne_disentangling_2013; @leblond_avoidance_2013; @laurian_interactions_2012]; there is also evidence of predators avoiding features heavily used by humans [@muhly_human_2011; @whittington_towns_2022; @proctor_effects_2020]. Changes in mortality risks, habitat quality, and connectivity associated with anthropogenic disturbance can in turn alter use and movement patterns [@tucker_moving_2018; @apps_factors_2006; @proctor_effects_2020], demography and population viability [@johnson_science_2020; @decesare_linking_2014; @barrientos_lost_2021; @apps_spatial_2013; @pinard_calving_2012; @fahrig_effects_2009; @lochhead_linking_2022; @apps_spatial_2013; @proctor_effects_2020]. Roads can also facilitate spread of invasive species [@riitters_landscape_2017], and enable other development activities [@johnson_growth-inducing_2020].

Increasingly rapid environmental change, improvements in available cyberinfrastructure, and development of open source data, tools and methods have contributed to growing interest in ecological forecasting models [@bodner_bridging_2021; @dietze_ecological_2017; @mcintire_perfict_2022]. In particular, forest landscape models that can account for harvest, fire, and other disturbances are widely and increasingly used to project the cumulative effects of climate change and forest management [@petter_how_2020; @albrich_simulating_2020; @hof_editorial_2021; @tremblay_harvesting_2018; @snell_importance_2018; @daniel_incorporating_2017; @stewart_climate-informed_2023; @micheletti_assessing_2021; @leblond_there_2022; @bouderbala_long-term_2022; @barros_empowering_2023], building on a rich history of spatial-stochastic models of forest growth and succession following disturbance [@sturtevant_understanding_2021]. Despite the importance of roads for wildlife, these models generally do not include road network projections. For example, in a recent collection of articles focussed on "Using Landscape Simulation Models to Help Balance Conflicting Goals in Changing Forests" [@hof_editorial_2021], only 4 of 14 mentioned roads [@haga_scenario_2020; @leston_quantifying_2020; @mikusinski_strengthening_2021; @norris_forecasting_2021], and only one includes a road projection [@leston_quantifying_2020].

Leston et al. (2020) project forest road network development using Patchworks [@spatial_planning_systems_patchworks_nodate], then add fire. This example highlights that roads are also important for harvest planning, and that road network projection methods are integrated into a widely used optimization-based spatial harvest planning tool. However, Patchworks is proprietary closed-source commercial software, and the road network projection algorithm contained therein is difficult to assess or fully integrate into models that include stochastic disturbances [@sturtevant_understanding_2021; @de_pellegrin_llorente_recognizing_2017]. Published methods intended to support strategic planning [@anderson_projecting_2004; @clark_three-stage_2000; @dean_finding_1997] require inputs that are not publicly available, and employ algorithms that are too complex and detailed for application at regional, provincial or national scales. More promising options for projecting forest road network development at large scales include an iterative least cost path method developed by Hardy [-@hardy_forest_2019], and least cost path and minimum spanning tree algorithms used to project roads and reconstruct development history in British Columbia [@lochhead_demo_2018; @lochhead_linking_2022]. The former method is available as QGIS and Landis plugins, and the latter is embedded in a larger open source modelling project that is specific to British Columbia [@muhly_castor_nodate]. These methods have not been formally assessed, compared, published, or implemented in a way that allows for easy integration into the full variety of modelling frameworks used for forecasting forest change in Canada and elsewhere [e.g. @barros_empowering_2023; @daniel_state-and-transition_2016; @scheller_forest_2004].

In this work, we address the need for adequately accurate forest road network projection tools that are also widely and easily applicable by implementing simple iterative least cost path and minimum spanning tree methods in an open source R package. We compare the ability of these methods to reconstruct observed forest road network development since 1990 in a mountainous region of British Columbia using performance metrics relevant to wildlife. The adequacy of a road network projection method depends on the purpose of the projection, and it is important to select performance metrics that reflect the purpose. Common predictors in models of the impacts of roads on wildlife include distance to roads [], buffered disturbance footprint [@johnson_science_2020; @ibisch_global_2016; @lochhead_linking_2022; @polfus_identifying_2011], and density [@apps_factors_2006; @apps_spatial_2013; @serrouya_time_2017]. We expect projecting these measures to be less challenging than projecting the spatial location of each road segment, and we do not expect good projections of road locations from the algorithms considered here. Our goal is to assess the ability of simple iterative least cost path and minimum spanning tree methods to project footprint, distance and density metrics that are commonly used to predict impacts of roads on wildlife.

```{=html}
<!-- TO DO:
- more thorough review of SMC & grizzly papers
- summarize road metric types used in cited papers more systematically.
-->
```
```{=html}
<!--
See notes here:
https://docs.google.com/document/d/1UQ_iC69QX0qX86NM6zSSQ036CgslN-uCXCdBY-4nU5M/edit
Effects of roads on wildlife include increased mortality from various types of encounters with humans, alterations in behaviour and interactions among predators and prey, and spread of invasive species (Trombulak and Frissel 2001). In boreal forests and coniferous forests of the Columbia and Rocky mountains, notable impacts of logging roads include facilitation of movement by wolves (Mumma et al. 2018; Dickie et al. 2020), attraction of bears to roadside food resources (Roever et al. 2010; Bastille-Rousseau et al. 2011; Dickie et al. 2020), increased mortality caused by humans near roads and trails (Roever et al. 2010), and avoidance by ungulates (Laurian et al. 2015; Dickie et al. 2020). Forest dwelling boreal woodland and mountain caribou avoid roads leading to a loss of available habitat (Polfus et al. 2011; Dickie et al. 2020), and suffer increased mortality near roads (Bastille-Rousseau et al. 2011; Mumma et al. 2018). At a range scale, survival and recruitment of boreal caribou declines with anthropogenic disturbance (Johnson et al. 2020). Eight herds of Southern Mountain Caribou have been extirpated or likely extirpated, and remaining herds are considered Endangered by COSEWIC  and listed as threatened under the Canadian Species at Risk Act (SARA) (Palm et al. 2019). Most boreal caribou populations with ranges that include intensive forest management activity are not self-sustaining (ECCC 2011; Johnson et al. 2020), and boreal caribou are also listed as threatened under SARA.


Nonlinear responses of elk to road density (Frair et al. 2008). Black bear responses to roads vary with road type (Zeller et al. 2020), and selection for roadside vegetation can increase neonatal boreal woodland caribou mortality in areas near roads . 
For more careful reading: Flyal et al. 2019; Jaeger et al. 2005; Laurance et al. 2014; Psaralexi et al. 2017; Apps et al 2014; Beyer et al. 2014; Blagdon and Johnson 2021; Suzuki and Parker 2016; Fahrig and Rytwinski 2009; Coffin et al. 2021; Crist et al. 2005; Grantham et al. 2020;Johnson et al. 2019; Meijer et al. 2018; Langeveld et al. 2009

Continue reviewing pdfs in downloads - 

-->
```
<!-- One unpublished QGIS plugin by Clement (2021) is available for projecting forest roads and is also included in the analysis of this paper (GitHub - Klemet/ForestRoadNetworkPluginForQGIS: A plugin for QGIS that is able to construct a forest road network based on a cost matrix, polygons to reach, a current road network, the dijkstra algorithm and 3 network-creation heuristics.). -->

<!-- Our goal is provide simple, accessible, and usable forest road network projections that can easily be applied in the context of large-scale landscapes and wildlife impact simulations. Our model will be openly accessible and uses minimal input parameters (an existing road network, harvest cutblocks, and cost surface) which makes it easily transferable to many forest resource dominated landscapes. Here, we evaluate its accuracy at simulating forest road development across a large landscape by recreating the network starting from approximately 1990 and comparing it to the present day observed forest road network. In order to compare the projected and observed road networks, we used various metrics that are similar to those used in wildlife impact studies to compare the projected and observed landscapes both spatially and aspatially. -->

<!-- value of roadless areas: [@ibisch_a_2016; @talty_conservation_2020; @psaralexi_importance_2017] -->

<!-- forest mgmt planning models: [@depellegrinllorente_recognizing_2017] -->

<!-- other of interest: caribou habitat metric [@whitman_a_2017] -->

<!-- Resource extraction, such as forest harvesting, is the main driver of road construction in much of Canada's forested area. In British Columbia, over 600 000 kilometers of resource roads make up the vast majority of the province's total road network (83%) (Environmental Reporting BC, 2018; Forest Practices Board, 2015). Over 75% of resource roads in the province were built by the forest industry (Forest Practices Board, 2015). -->

<!-- Forest simulation models generally either fall into two categories: deterministic and stochastic (Boychuk et al., 2009; Helmes & Stockbridge, 2011). -->

# Methods

## Study Area and Data

We chose the Revelstoke timber supply area (TSA 27), in British Columbia, Canada as an assessment area because forestry is the dominant resource extraction activity in this region and much of the road network was built to access forest harvest cutblocks (Figure \@ref(fig:study-area)). This allows projection of the forest road network from historic forest harvest data. Approximately 55% of the area is non-forested land where road building is difficult or impossible (e.g. alpine, lakes, swamp, brush, rock) [@hachey_revelstoke_2010], so the area provides opportunities to observe the responses of road projection algorithms to barriers. Revelstoke is in the interior-wet belt of the province where forests are dominated by Englemann spruce (31%), Hemlock (23%), Cedar (22%), and Douglas-fir (18%) [@ministry_of_forests_revelstoke_2021]. The area is home to wildlife species that are sensitive to roads including grizzly bears and Southern Mountain woodland caribou [@hachey_revelstoke_2010]. Eight herds of Southern Mountain caribou have been extirpated or likely extirpated, and remaining herds are considered Endangered by COSEWIC and listed as threatened under the Canadian Species at Risk Act [@palm_long_2020]. Mountain caribou avoid roads leading to a loss of available habitat [@polfus_identifying_2011; @apps_factors_2006], suffer increased mortality near roads [@apps_spatial_2013], and decline in abundance as the footprint of roads and cutblocks increases [@lochhead_linking_2022]. Roads also alter grizzly habitat use, home range selection, movements, population fragmentation, survival, reproductive rates, population density, trends, and conservation status [@proctor_effects_2020].

```{r setup2}
library(ggplot2)
library(dplyr)
library(stringr)
library(tidyr)
library(purrr)
library(ggpubr)
library(MetBrewer)
library(here)
library(tmap)
library(sf)

devtools::load_all(here())

#set paths
data_path_raw <- "analysis/data/raw_data/"
data_path_drvd <- "analysis/data/derived_data/TSA27"

pal_nm <- "Redon"

fig_widths <- c(min = 1.18, single = 3.543, mid = 5.51, two = 7.48)
```

```{r study-area, fig.cap="Revelstoke timber supply area in British Colombia, Canada. The colour shows the cost of building roads across each pixel.", cache=TRUE}
tsaBoundary <- read_sf(here(data_path_raw, "tsa27_boundaries.gpkg"))
#cost surface raster layer
tsaCost <- terra::rast(here(data_path_drvd, "input_cost.tif"))

tsaCost <- terra::mask(tsaCost, terra::vect(tsaBoundary))

canada <- geodata::gadm("CAN", level = 1, path = here(data_path_raw))

canada <- canada %>% 
  st_as_sf() %>% 
  filter(COUNTRY == "Canada") %>% 
  st_transform(st_crs(tsaBoundary)) %>% 
  st_simplify(dTolerance = 10000)

canada_overlay <- tm_shape(canada, projection = "+proj=lcc +lat_1=20 +lat_2=60 +lat_0=40 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs")+
  tm_borders(col="black")+
  tm_shape(st_buffer(tsaBoundary, 10000))+
  tm_polygons(border.col = met.brewer(pal_nm, 1), col = met.brewer(pal_nm, 1))+
  tm_layout(frame=TRUE)

tsa <- tm_shape(tsaCost, name = "Cost")+
  tm_raster(style = "cont", title = "Cost")+
  tm_shape(st_union(tsaBoundary))+
  tm_borders(col = "black")+
  tm_compass(position = c(0.3, 0.11), size = 1)+
  tm_scale_bar(position = c("center", "bottom"), text.size = 1)+
  tm_layout(legend.position = c("left", "bottom"),
            legend.bg.color = "white")
  

vp <- grid::viewport(x=0.965, y=0.945, width = 0.35, height=0.2,
               just=c("right", "top"))

tmap_save(tsa, filename = here("analysis/figures/Figure1_StudyArea.png"),
  dpi = 600, insets_tm = canada_overlay, insets_vp = vp,
  height = 6, width = fig_widths["single"], units = "in")

knitr::include_graphics(here("analysis/figures/Figure1_StudyArea.png"))

```

Our road network data was obtained by combining the digital road atlas (DRA) [@data_bc_digital_2021] and forest tenure road [@british_columbia_ministry_of_forests_lands_natural_resource_operations_and_rural_development__flnrord_forest_2021] data sets for BC. To avoid situations where the same road was included in both data sets with slightly different coordinates, we removed all roads from the DRA data set that were within 50 m of a road in the forest tenure road data set. The existing road network, used as the starting point for projections, was created by filtering out forest tenure roads with an award date greater than 1990. All roads from the DRA data set were assumed to be built before 1990. Cutblock information was obtained from the Harvest Areas of BC (Consolidated Cutblocks) dataset [@government_of_british_columbia_harvested_2021]. Cutblock information is compiled from provincial Forest Cover, the RESULTS Reporting system, Forest Tenure applications, and satellite imagery using change detection processes. The dataset does not exclude non-harvested 'reserved' areas, and satellite image change detection may not always represent the entire cutblock area [@government_of_british_columbia_harvested_2021]. Forest harvest cutblocks with harvest years greater than 1990 were filtered and used as targets for the projections.

To spatially define the cost of building and traveling on a forestry road we developed a simple model informed by slope and major barriers (Table 1). Following the Interior Appraisal Manual of BC, we assume the base cost per kilometer of road is a linear function of slope [@government_of_british_columbia_interior_2021], and that road construction across major water bodies is prohibitively expensive (Table \@ref(tab:cost-tbl)). Existing roads are assigned a cost of 0. The cost raster consists of 1,703,936 pixels with a resolution of 1 ha.

```{r cost-tbl}
tbl <- "Cost Type|Value ($ per km)|Source
Slope|16178 + 504*slope|Interior appraisal manual
Major lakes|65000|Major water bodies of BC
Existing roads|0|Digital road atlas and forest tenure roads for BC
"
df <- read.delim(textConnection(tbl),header=FALSE,sep="|",strip.white=TRUE,stringsAsFactors=FALSE)
names(df) <- unname(as.list(df[1,]))
df <- df[-1,] # remove first row
row.names(df)<-NULL
knitr::kable(df, caption = "A simple model of road construction costs.")
```

All data sets were accessed using the `bcdata` R package and filtered to the extent of the Revelstoke Timber Supply Area [@teucher_bcdata_2021]. These data sets are continuously updated so we have stored the versions used in our analysis in an Open Science Framework repository (https://osf.io/8vmqh/). We were not granted permission to share the DRA data set so it must be accessed from <https://catalogue.data.gov.bc.ca/dataset/bb060417-b6e6-4548-b837-f9060d94743e>.

<!-- TO DO: add link to OSF repository once public-->

## Road Projection Methods and Variants

Simple methods for projecting low-cost routes from an existing road network to target locations (i.e. harvest cutblocks) include simple least cost paths (LCP), dynamic least cost paths (DLCP) and least cost path minimum spanning trees (MST) (Figure \@ref(fig:proj-meth-fig)). We use Dijkstra's shortest path algorithm [-@dijkstra_note_1959] to determine the least cost path between a target location (e.g. centroid of a cutblock) and the existing road network. Least cost paths to each cutblock are determined independently in the simple method (LCP). The dynamic least cost paths (DLCP) method evaluates the path to each cutblock in sequence so that earlier paths are considered in the cost for later paths. Sequence is determined by a heuristic, such as the distance to the nearest existing road in these examples. The minimum spanning tree (MST) method calculates the minimum cost network to connect all cutblocks to the road network using Kruskal's algorithm [-@kruskal_shortest_1956]. See Appendix A for a more detailed explanation of these methods. We focus our analysis on the DLCP and MST approaches which yield more realistic road networks (Figure \@ref(fig:proj-meth-fig)). We compared these methods to an alternative iterative least cost path method developed by Hardy [-@hardy_forest_2019].

The DLCP and MST methods connect target or landing locations within each cutblock to the existing road network, so an important first step is to select one or more landing locations in each block. We investigated the sensitivity of results to the pattern and density of landing locations by comparing results derived from the centroid of each cutblock to regular or randomly selected landing densities of 1 (low) and 10 (high) points per km^2^ (Figure \@ref(fig:proj-meth-fig)). We used default settings in the Hardy QGIS plugin except for skidding distance which was set to 200m. A skidding distance of 200 m corresponds to \~ 9 pts/km^2^. We compared two resolutions of the cost surface by aggregating the 1 ha resolution cost raster to a coarser 100 ha (1000 by 1000 m) resolution. In total, we compared 12 road projection method variants to a cutblocks only scenario with no projected roads (Table \@ref(tab:method-tbl)).

```{r method-tbl}
tbl2 <- "Projection method|Sample type|Sample density (pts/km^2^)|Resolutions
MST|Regular|1|1 ha and 100 ha
MST|Regular|10|1 ha and 100 ha
MST|Random|1|1 ha and 100 ha
MST|Random|10|1 ha and 100 ha
MST|Centroid|N/A|1 ha and 100 ha
DLCP|Regular|10|1 ha 
Hardy QGIS|N/A|~9|1 ha
Cutblocks only|N/A|N/A|1 ha

"
df2 <- read.delim(textConnection(tbl2),header=FALSE,sep="|",strip.white=TRUE,stringsAsFactors=FALSE)
names(df2) <- unname(as.list(df2[1,]))
df2 <- df2[-1,] # remove first row
row.names(df2)<-NULL
knitr::kable(df2, caption = "Road projection method variants.")
```

To help make these road network projection methods more easily and widely applicable, we implemented the simple least cost path, dynamic least cost path and minimum spanning tree methods in the open source R package `roads` [@endicott2023]. The 'roads' package is dependent on several other R packages that made this work possible, including, among others: `igraph` for calculating least cost paths and minimum spanning trees [@csardi2006a; @igraph:2022], `terra` for manipulating spatial raster data [@hijmans2023], and `sf` for manipulating spatial vector data [@pebesma2018; @pebesma2022]. The package is available on CRAN (The Comprehensive R Archive Network) and a website with tutorials and detailed documentation is available (<https://landscitech.github.io/roads/>). The source code for the package is available on GitHub (<https://github.com/LandSciTech/roads>).

```{r, cache=TRUE}
# Example area for demonstrating different methods

library(dplyr)
library(sf)
library(roads)
library(terra)
library(tmap)
library(purrr)
library(caribouMetrics)
library(pfocal)


# read in example area data
exRoads <- read_sf(here(data_path_drvd, "..", "testing_ex_roads.gpkg"))
tsb <- read_sf(here(data_path_drvd, "..", "testing_tsb.gpkg"))
cutblocks <- read_sf(here(data_path_drvd, "..", "testing_cutblocks.gpkg"))
tsaCost <- raster::raster(here(data_path_drvd, "..", "testing_cost.tif"))
roads <- read_sf(here(data_path_drvd, "..", "testing_obs_roads.gpkg"))

# densities
high <- 0.00001
low <-  0.000001

sampleDens <- c(high, high, low)
sampleType <- c("regular","random","centroid")
paramTable <- tibble(sampleType, sampleDens,
                     method = "mst",
                     runTime = vector("list", length(sampleDens)),
                     output = vector("list", length(sampleDens)),
                     roadDisturbance = vector("list", length(sampleDens)),
                     roadDensity = vector("list", length(sampleDens)),
                     roadPresence = vector("list", length(sampleDens)),
                     distanceToRoad = vector("list", length(sampleDens)),
                     forestryDisturbance = vector("list", length(sampleDens))) %>%
  distinct()

# re-run projections for just the small area with different parameters
mstProj <- projectAll(tsbs = tsb, paramTable = paramTable,
                      costSurface = tsaCost,
                      cutblocks = cutblocks,
                      existingRoads = exRoads,
                      fileLocation = here(data_path_drvd, "..", "for_fig"))

dlcpProj <- projectAll(tsbs = tsb,
                      paramTable = paramTable %>% 
                        filter(sampleType == "regular") %>% 
                        mutate(method = "dlcp"),
                      costSurface = tsaCost,
                      cutblocks = cutblocks,
                      existingRoads = exRoads,
                      fileLocation = here(data_path_drvd, "..", "for_fig"))

allProj <- bind_rows(mstProj, dlcpProj, .id = "method") %>%
  arrange(desc(sampleType), sampleDens)

# add Hardy QGIS results for the same area

allProj <- bind_rows(
  allProj,
  tibble(sampleType = "", sampleDens = 0, method = "Hardy QGIS",
             output = list(here(data_path_drvd, "..", "for_fig", 
                                "HardyQGISTest.gpkg")))) %>% 
  mutate(mapTitle =  paste(ifelse(method == 1, "MST",
                                  ifelse(method == 2, "DLCP", method)),
                           sampleType,
                           ifelse(sampleDens == 1e-06 & 
                                    sampleType != "centroid", "low density", 
                                  ifelse(sampleDens == 1e-05, 
                                         "high density", ""))))

# add extra row for legend
allProj <- bind_rows(allProj, 
                     slice(allProj, 1))

allMaps <- purrr::map(
  1:nrow(allProj),
  ~ qtm(tsaCost, raster.style = "cont", raster.palette = "Greys",
        raster.alpha = 0.5, raster.title = "Cost")+
    qtm(cutblocks, fill = NULL, borders = "grey40", borders.lwd = 1.5)+
    qtm(roads, lines.col = "red", lines.lwd = 2)+
    qtm(read_sf(here(allProj$output[[.x]])), lines.col = "yellow", lines.lwd = 2)+
    qtm(exRoads, lines.col = "black", lines.lwd = 2)+
    tm_layout(legend.show = .x == nrow(allProj),
              legend.only = .x == nrow(allProj),
              main.title = allProj$mapTitle[[.x]],
              main.title.size = 0.75))

allMaps[[nrow(allProj)]] <- allMaps[[nrow(allProj)]]+
  tm_add_legend(type = "line", 
                labels = c("Existing roads", "Projected roads", "Observed roads"),
                col = c("black", "yellow", "red"))+
    tm_add_legend(type = "fill", 
                labels = "Cutblocks",
                col = NA, border.col = "grey40")+
  tm_layout(legend.only = TRUE, legend.position = c("center", "center"))


tmap_save(tmap_arrange(allMaps, ncol = 3),
          here("analysis/figures/projection_methods_figure.png"),
          dpi = 300, height = 5, width = fig_widths["two"])
```

```{r proj-meth-fig, fig.cap="We compared minimum spanning tree (MST), dynamic least cost paths (DLCP) and the Hardy QGIS plugin road network projection algorithms. Landing locations were selected as the centroid of the cutblock, or a random or regularly spaced sample of points inside each cutblock (Table 2). Target cutblocks are outlined in grey, existing roads are black, projected roads are yellow, observed roads are red. Cost (1 ha resolution) is indicated by grey shading, with darker grey indicating higher cost. The large four sided cutblock in the top right was added to give a better example of the algorithms behaviour inside cutblocks."}
knitr::include_graphics(here("analysis/figures/projection_methods_figure.png"))
```

## Performance Metrics

In order to assess the performance of the projections, five characteristics of the projected and observed road networks were calculated and compared: 1) Road presence, measured as whether or not roads are present in each pixel; 2) Road density, measured as density of roads in meters per hectare (m/ha); 3) Distance to nearest road, measured as distance from each raster cell to the nearest road; 4) Road disturbance footprint, measured with a 1 km buffer around roads [@ibisch_global_2016]; and 5) Forestry disturbance footprint, measured with a 500 m buffer around roads and cutblocks. The forestry disturbance footprint is a variant of the buffered anthropogenic disturbance metric that is used as an indicator of boreal caribou critical habitat [@johnson_science_2020], and road density is often used in studies of anthropogenic impacts on wildlife [@beazley_road_2004; @apps_factors_2006; more]. Forestry disturbance footprint and road density were calculated using the *disturbanceMetrics* and *rasterizeLineDensity* functions in the `caribouMetrics` R package [@hughes_cariboumetrics_2022]. Distance to nearest road was calculated using a fast parallel moving window method implemented in the *getDistFromSource* function of the `roads` package. All road characteristics were stored in raster format.

<!-- TO DO: Discuss why we do not calculate the 50m buffer metric used by Kyle for SMC. 50 m buffer is basically built in to the 100 m raster resolution. Road presence would be our closest equivalent measure - and we don't project that measure very well. -->

The aspatial performance of the projections was assessed by calculating the mean values of each road network characteristic and comparing the projected and observed values. This was done across the timber supply area and within cutblocks by masking the road network characteristic rasters with cutblock polygons and calculating means within cutblocks. Spatial performance was assessed in two different ways. First, difference maps were created by subtracting the projected distance to the nearest road from the observed in order to highlight discrepancies between the road networks. The observed and projected road networks were then overlain on the difference maps and regions of major discrepancies were investigated using Google satellite imagery in QGIS. Second, performance according to the three binary metrics (road presence, road disturbance footprint, and forestry disturbance footprint) was assessed by categorizing pixels of a projected raster into 5 categories compared with the observed raster: 1) pre-existing footprint; 2) agree roadless, meaning that both projected and observed show no footprint; 3) agree roaded, meaning that both projected and observed show new footprint; 4) false positive, meaning the projection shows a footprint but no footprint was observed; and 5) false negative, meaning the projection shows no footprint but a footpint was observed. These categories were summarized for each projection and characteristic and used to calculate sensitivity, precision and F-measure of each metric [@lee_prediction_2021]. Sensitivity, also known as recall, gives the proportion of the true positives that were projected, while precision gives the proportion of positives projected that are true. Sensitivity will be lower when observed roads are missed and precision will be lower when roads are projected that were not observed. F-measure attempts to balance sensitivity and precision to give an overall score.

# Results

## Aspatial performance
For each projection method variant the aspatial performance varied across the five road network metrics and also varied depending on whether we consider scores within cutblocks, outside cutblocks, or overall (Figure \@ref(fig:aspat-perf-fig)). All road network projection method variants represent an improvement over the "cutblocks only" method where cutblocks were the only disturbance considered. Within all cutblocks, the Hardy method most accurately projects road density, and least accurately projects distance to road. Low density method variants most severely underproject road density within cutblocks, and most accurately project distance to road within cutblocks. These apparently contradictory results are explained by areas in our input data that have been misidentified as cutblocks with no associated observed roads (e.g. Figure \@ref(fig:proj-map-fig)b). Omitting cutblocks without observed roads from the comparison (Figure \@ref(fig:aspat-perf-fig) row 2) clarifies that within cutblocks the Hardy method more accurately projects ... All methods underproject road density, in part because within 1 ha pixels all the methods generate straight road segments. All the methods also underproject road presence, and the problem is more severe for the low density method variants. In general, performance differences among low and high density method variants are larger than differences among projection algorithms. With the coarser resolution cost raster road projections had mean road presence that was closer to the observed, while road density was further from the observed mean and distance to the nearest road was further from the observed mean inside cutblocks but closer for the landscape overall (Figure A-\@ref(fig:figA1)).

Outside cutblocks, all method variants underproject road density and road presence, and there is little variation in performance among them (Figure \@ref(fig:aspat-perf-fig)). Comparison of observed and projected road networks clarifies that projected roads cross valley bottoms far more often than observed roads which often run parallel to one another on each side of rivers (Figure \@ref(fig:proj-map-fig)a). Accounting for the costs of crossing streams, rivers and other wet areas in valley bottoms could likely reduce this discrepancy. Another source of discrepancy between observed and projected networks in this mountainous landscape are switchbacks on steep slopes (Figure \@ref(fig:proj-map-fig)c). None of the simple algorithms considered here are capable of projecting switchbacks. Overall, projections of distance to road, the forestry disturbance footprint, and the road disturbance footprint are more accurate than projections of road density and road presence (Figure \@ref(fig:aspat-perf-fig)), suggesting that these measures are easier to project.  

```{r get-data}
# load csv
meanTable <- read.csv(here(data_path_drvd, "mean_table.csv"))
meanTableRealCuts <- read.csv(here(data_path_drvd,"../TSA27_real_cuts",
                                   "mean_table.csv"))
matchData <- read.csv(here(data_path_drvd, "agree_table.csv"))

```

```{r aspat-perf-fig, fig.height=4, fig.width=fig_widths["two"], fig.cap="Proportional difference of projected mean from observed mean road metrics using different projection method variants with a 1 ha resolution cost raster. Metrics were summarised within cutblocks, outside cutblocks, and overall. Values greater than 0 indicate overprojection of the metric and negative values indicate an underprojection. The cutblocks only method is not defined for the road density, road presence or distance to road characteristics."}
# organize data for ggplot
meanTable_long <- meanTable %>% dplyr::select(-runTime, -order) %>% 
  pivot_longer(-c(sampleType, sampleDens, areaMean, method),
               names_to = "metric", values_to = "response")%>%
  mutate(sampleType = ifelse(sampleType == sampleDens, NA_character_, 
                             sampleType),
         sampleDens = paste(method, sampleType, sampleDens) %>% 
           factor(levels = c("mst NA centroid",
                             "NA NA observed",
                             "mst random low sample density",
                             "mst regular low sample density",
                             "mst random high sample density",
                             "mst regular high sample density",
                             "dlcp regular high sample density",
                             "NA NA klementQGIS",
                             "NA NA NA"),
                  labels = c("MST centroid", 
                             "Observed",
                             "MST random low density",
                             "MST regular low density",
                             "MST random high density",
                             "MST regular high density",
                             "DLCP regular high density",
                             "Hardy QGIS",
                             "Cutblocks only")),
         metric = factor(metric,
                         levels = c("roadDensityMean", "roadPresenceMean",
                                    "distanceToRoadMean",
                                    "forestryDisturbanceMean",
                                    "roadDisturbanceMean"),
                         labels = c("Road\ndensity", "Road\npresence",
                                    "Distance\nto road",
                                    "Forestry\ndisturbance\nfootprint",
                                    "Road\ndisturbance\nfootprint")))


observed_values <- filter(meanTable_long, sampleDens == "Observed")
projected_values <- filter(meanTable_long, sampleDens != "Observed")

# get proportional difference from observed
prop_dif <- projected_values %>% 
  left_join(observed_values %>% select(areaMean, metric, response),
            by = c("areaMean", "metric"), 
            suffix = c("_proj", "_obs")) %>% 
  mutate(prop_dif = (response_proj-response_obs)/response_obs,
         areaMean = factor(areaMean, labels = c("Cutblocks", "Outside\ncutblocks",
                                                "Overall")))


# save runTimes for later comparison
dlcp_time <- meanTable %>% filter(method == "dlcp", areaMean == "overall") %>% 
  pull(runTime) %>% round(2)

mst_time <- meanTable %>% filter(method == "mst", areaMean == "overall",
                                 sampleType == "regular", sampleDens == "high sample density") %>% 
  pull(runTime) %>% round(2) %>% `*`(60)

prop_dif %>% 
  ggplot(aes(x = sampleDens, prop_dif, fill = sampleDens))+
  geom_hline(aes(yintercept = 0), color = "grey")+
  geom_col(position = position_dodge2(preserve = "single",
                                      width = 0.75))+
  facet_grid(areaMean~ metric, scales = "free")+
  theme_classic()+
  scale_fill_manual(values = met.brewer(pal_nm, 8) %>% .[c(8, 1:7)],
                    name = "Sampling\nMethod", guide = "none")+
  theme(text = element_text(size = 10), axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "right",
        axis.text.x=element_text(size=11, angle=50, vjust=1, hjust=1))+
  coord_flip()

```

```{r proj-map-fig, fig.height=9, fig.width=fig_widths["two"], fig.cap="Comparison of projection results for the minimum spanning tree projection with regular high density sampling to the observed road network. The primary map shows the observed distance to the nearest road minus the projected distance and the insets show close-ups of the road networks with satellite imagery to give more context. a) Projected and observed road networks follow similar patterns although projected roads cross valley bottoms more frequently. b) An example of a misidentified cutblock. c) Projected roads do not match observed switchback roads.  The satellite images are from Google (2022)."}

knitr::include_graphics(here("analysis/figures/Figure4_diff_map_update.png"))

```

```{r spat-perf-fig, fig.height=4.5, fig.width=fig_widths["two"], fig.cap="Comparison of performance metrics for each projection method variant using the 1 ha resolution cost raster. F-measure is the harmonic mean of precision and sensitivity, precision is the proportion of predicted roads that are observed roads and sensitivity is the proportion of observed roads that were correctly predicted. Values closer to one indicate better performance."}

matchData_sum <- matchData %>% ungroup() %>%
  mutate(agreement = factor(agreement,
                            levels = c("False negative", "False positive",
                                       "Agree roaded","Agree roadless",
                                       "Pre-existing roads")),
         sampleDens = paste(method, sampleType, sampleDens) %>%
           str_replace("1e-06", "low density") %>%
           str_replace("1e-05", "high density") %>%
           str_replace("centroid low density", "centroid") %>%
           str_replace("klementQGIS NA", "klementQGIS") %>%
           factor(levels = c("mst centroid",
                             "mst random low density",
                             "mst regular low density",
                             "mst random high density",
                             "mst regular high density",
                             "dlcp regular high density",
                             "NA klementQGIS", 
                             "NA cutOnly NA"),
                  labels = c("MST centroid", 
                             "MST random low density",
                             "MST regular low density",
                             "MST random high density",
                             "MST regular high density",
                             "DLCP regular high density",
                             "Hardy QGIS", 
                             "Cutblocks only")),
         metric = factor(metric,
                         levels = c("roadPresence",
                                    "forestryDisturbance",
                                    "roadDisturbance"),
                         labels = c("Road presence",
                                    "Forestry disturbance\nfootprint",
                                    "Road disturbance\nfootprint"))) %>%
  group_by(metric, sampleDens, agreement) %>%
  summarise(count = sum(count), .groups = "drop_last") %>%
  mutate(perc = count/sum(count)*100)


# performance table
perf_tbl <- matchData_sum %>% 
  pivot_wider(c(metric, sampleDens), names_from = agreement, 
              values_from = count, values_fill = 0) %>% 
  mutate(sensitivity = `Agree roaded`/(`Agree roaded` + `False negative`),
         precision = `Agree roaded`/(`Agree roaded` + `False positive`),
         F_measure = (2*precision*sensitivity)/(precision+sensitivity)) %>% 
  select(metric, sampleDens, sensitivity, precision, F_measure) 

perf_tbl_rng <- perf_tbl %>% group_by(metric) %>% 
  summarise(rng_F = range(F_measure, na.rm = TRUE) %>% round(3) %>% paste0(collapse = " - "), .groups = "drop") %>% pull(rng_F, name = metric)

perf_tbl %>% 
  pivot_longer(c(sensitivity, precision, F_measure), names_to = "perf_meas",
               values_to = "value") %>% 
  mutate(perf_meas = factor(perf_meas,
                            labels = c("F-measure", "Precision", "Sensitivity")),
         value = value  +0.01) %>%   # adding so 0 shows in figure
  ggplot(aes(sampleDens, value, fill = sampleDens))+
  geom_col()+
  scale_fill_manual(values = met.brewer(pal_nm, 8) %>% .[c(8, 1:7)],
                    name = "Sampling\nMethod", guide = "none")+
  facet_grid(metric ~ perf_meas)+
  coord_flip()+
  ylim(0, 1.01)+
  theme_classic()+
  labs(y = "Performance", x = NULL)

```

As expected, none of the projection methods yield accurate spatial projections of road presence (i.e. the exact locations of roads) (F-Measure: `r perf_tbl_rng["Road presence"]`). Neither do any of the methods provide better information about the exact location of the forestry disturbance footprint than the locations of cutblocks only (F-Measure: `r perf_tbl_rng["Forestry disturbance\nfootprint"]`). All methods provide comparably good projections of the road disturbance footprint (F-Measure: `r perf_tbl_rng["Road disturbance\nfootprint"]`), though higher sampling densities yield fewer false negatives and more false positives (Figure \@ref(fig:spat-perf-fig)). The DLCP projection method had slightly lower performance than the MST projection method with the same sampling strategy. The DLCP method was faster to compute however, with a run time of `r dlcp_time` minutes compared to `r mst_time` minutes for the MST method.

# Discussion

```{=html}
<!-- Discussion pts
- simple algorithms, practical to apply over large areas with minimal available information (unlike operational models)
- as expected, not great at projecting exact road locations. sources of discrepancy highlighted in this mountainous terrain include switchbacks, stream crossings, inaccurate harvest locations. we selected revelstoke because it is topographically complex, so a good challenge. Hardy result in eastern Canadian shield shows better overall accuracy projecting road density in less extreme terrain when the costs of water crossings are more carefully accounted for. Stream crossing behaviour in Revelstoke landscape could improved with more a detailed high resolution cost surface. But our results highlight that performance of these algorithms depends not only on accounting for cost but on complexity of the terrain. In particular, none of these simple algorithms will project switchbacks on steep slopes. A related fundamental limitation is that none of these algorithms can project tortuosity within raster cells, so in complex landscapes projections of road density will become less accurate as raster cell resolution increases. 
- Aspatial overall performance metrics can be difficult to interpret. To more deeply understand variation in projection accuracy we found it helpful to distinguish between performance within cutblocks and outside of them, and to examine spatial variation in discrepancies. Examination of spatial mismatch clarified that some discrepancies in our landscape are due to errors in our input data, rather than projection errors. Better harvest & existing road data would allow us to distinguish errors in projections from errors in the input data (cite lit in coops paper)
 - Outside cutblocks, we see very little variation in performance among our method variants - any of them are better than nothing. Within cutblocks that also have observed roads, the density of landing points has a much larger impact on performance than the choice of DCLP or MST algorthm, and the Hardy algorithm more accurately projects road density than either. Hardy algorithm is also less prone to putting roads on block edges. If accurate road density within blocks is primary goal, consider using Hardy algorithm. Thus far only implemented in Landis II and QGIS extension, but source code is open. If there is a need could integrate into roads R package. Or consider simpler adjustments to algorithms for selecting landing points such as placing landing points away from cutblock edges. 
- However, before investing in more complexity recognize that adequacy depends on the goal. For some purposes, projections from relatively crude cost models and simple algorithms may be adequate. For example, models of caribou movement often include distance to roads as a predictor, and at a landscape scale a combined metric of buffered anthropogenic disturbance best explains variation in boreal caribou demographic rates (). In our example landscape, projections of size disturbance footprints (500 m and 1km buffer) and distance to road are pretty good (and better than nothing). If our wildlife response models depend on distance to road or buffered disturbance footprint, these somewhat crude road projections are likely good enough.
- A related point is that it may helpful to recognize that some road metrics are easier to project than others when constructing model to project wildlife responses to disturbance ... (Bodner,). If interested in predictors that we did not consider, see example script. Can evaluate alternative metrics without rerunning the projections. 


However, This example projected new roads over fairly short distances, new landings were always fairly close to existing roads or other landings so there was not a lot of space for the projection to go wrong. 
-->
```
<!-- TO CONSIDER: provide example script that would make it relatively easy for someone to assess the performance of a new road metric of their choice. They don't need to run the projections to do this - just summarize the outputs using a method of their choice. -->

```{=html}
<!--  What David had
Through assessing the performance of our model by comparing its spatial and aspatial accuracy with the observed forest road network following 1990, we are satisfied that the projections provide adequate results given their intended use, and that it is a useful tool for projecting forest road networks across a large landscape with minimal input parameters. However, for applications where the exact location of roads is important (like operational road engineering purposes), or for projecting impacts on wildlife that respond to roads at a very fine spatial scale then this is not an appropriate model. The model does, however, have potential to be a useful tool for predicting impacts on wildlife across large landscape simulations and could easily be incorporated as an element into more complex models that take into account other landscape phenomena such as wildfires, climate change, etc. Because this model does not take timescales into account, it could be a useful post-processing tool as an element of more complex models as it can be applied retroactively to landscape simulations.

Many of the major discrepancies between the projections and the observed network had to do with potential issues with the available data. Often major discrepancies were related to cutblocks that were likely incorrectly labelled (most often through LANDSAT change detection) in places where there weren't actually cutblocks. These discrepancies had a negative influence on the overall spatial and aspatial accuracy of the projections. In order to get more accurate road projections, one could simply remove the cutblocks derived from LANDSAT as these were often the cutblocks which caused issues, however, these cutblocks were left in as a major goal of this assessment was to create road projections while adjusting input parameters as little as possible. Considering how this model will be used to simulate forest roads moving into the future, it is unlikely that potential future cutblocks will be mislabelled as they were in our situation and this would not be an issue. *Another potential issue was with roads not being included in the data set that were seen in the satellite imagery.* (this is no longer identified in the results section since it wasn't a major discrepancy after fixing the road data source) This issue relates to results from the study by Poley et al (in review) that demonstrated how road network datasets are almost universally incomplete and that many low-use roads (such as forest resource roads) can be seen within recent satellite imagery but are not included in any readily available road datasets. Mapping of roads is often especially lacking in more rural, forested, and mountainous regions where roads are often unpaved (Prendes et al., 2017) with the Auditor General of British Columbia (2017) suggesting that 100 000 km of resource roads are missing from publicly-available road network maps (inspired by Adam Ford's doc). This means there were areas where the projections built a road, causing a discrepancy, but in reality there was actually an observed road there as seen in the satellite imagery. These discrepancies also negatively impacted the spatial and aspatial accuracy results when they shouldn't have and should be treated with caution. It is possible that some roads seen in the satellite images have since been closed which could be a reason for them being absent in the roads data sets. Again, this would not present an issue when predicting future impacts on landscapes, only when assessing the model accuracy in this context. Having said this, the projections were deemed most accurate in areas where the quality of the cutblock and road data was high and consistent with what was seen in recent satellite images.

Although this model works well in an area like Revelstoke where the road network is located in a region dominated by forestry roads, it does not work well in landscapes where roads are developed based on other targets outside of cutblocks (where the intent to build the road is not to achieve the least cost path; aka seismic lines). Fort Nelson TSA (TSA 8), for example, contains a large amount of non-forestry roads which are related to seismic lines, oil and gas extraction, etc (\@ref(fig:ftNelson)). Because of this, forestry roads make up a much smaller percentage of the overall road network. In landscapes like this, it does not make sense to use the forestry road projections as many roads are influenced by many different factors. However, other resource extraction activities could likely be incorporated into this model relatively easily. The same concept could be used where mining or oil locations could be used as target locations instead of cutblock areas.

It is also worth noting that although the model can project road networks fairly accurately across a large landscape, it may differ from the way in which roads are planned in real life. The model will simply build the roads in the least costly locations based on the cost surface, however often in the real world, roads must be planned around ownership and administrative boundaries. In BC, forestry roads are developed by forest licensees under a timber harvesting permit (Government of British Columbia, 2021c).

Certain projection methods were more accurate at projected some metrics compared to others. Similarly, certain metrics were sensitive to pixel size (road density, road presence) and others were not. Depending on what the goal of running the projections is, then the projection method and resolution may or may not play an important role. If you would like to predict road density as accurately as possible, then running the projections using as fine a resolution of cost surface as possible is the best option. If you're wanting to only predict roughly the location of the roads/save computing time and are more interested in a larger area, then a coarse resolution may suit these requirements perfectly fine. The tradeoffs of using a coarser resolution of cost surface may be less extreme when projecting roads across a flatter landscape compared to a mountainous landscape like was used for this paper since there would likely be less variability in cost across larger areas.

With caribou being one of the key considerations when managing some forestry areas (like in British Columbia TSAs, including Revelstoke TSA) (Government of British Columbia, 2021), the accuracy at which "roads" can project this forestry disturbance footprint metric could allow for this package to be a truly beneficial tool for assessing the impacts towards at-risk caribou populations when looking at various forest harvest scenarios. Because caribou are also considered an umbrella species within forests (Drever et al., 2019), projecting forestry impacts on their habitats may also provide valuable insight towards other key species as well. With the input of future cutblocks and the projections of forest road networks to these cutblocks, the results from the projection can provide a great outlook at the impacts of forestry scenarios on woodland caribou habitats using the forestry disturbance footprint metric. The distance to nearest road metric appears to be a very interesting metric to consider as well when looking specifically at larger areas. Using this metric to make projections at larger scales, such as at a TSA level, may provide very beneficial information about forestry impacts especially in a wildlife context when assessing the influence of forestry on various species with different tolerances to disturbance.

Further improvements could be made that would increase the accuracy of the model. The cost surface used for this paper was developed at a provincial scale, however, a higher resolution cost surface with more detail could further improve the accuracy of the projection results. A finer resolution cost surface with more detail will ultimately create a more realistic road network and would possibly allow for more accuracy within cutblocks (where fine micro-topography, water tables, etc. will play a role in road development). The downside being that it would also increase computing time and may not always be necessary depending on the application of the model, especially when using the model for a large-scale landscape. Adding too much complexity to the cost surface may also take away from the goal of this model to be simple and easy to use, however, the algorithm itself would work on a very fine and detailed cost surface. Along with increased computing time, a key limitation of using this model on a finer cost surface would be that eventually cost pixels would need to have directionality associated with them, which is something this model does not take into account. The accuracy of comparing the projections to the observed network could also simply be improved by using higher quality/more up to date road and cutblock data.

Assessing the performance of this model also presented some unique challenges with comparing two networks with each other across a landscape. We needed to carefully think about what we were trying to achieve. The goal wasn't to present a model that matched the observed road network pixel by pixel, but instead was to simulate disturbance across a large-scale landscape to an acceptable level while still being a relatively simple and straightforward tool. It's for this reason why metrics were chosen that are commonly used in road impact assessments on wildlife; such as the road density and forestry disturbance footprint metrics. Once the vector networks were converted into these raster layers, it also facilitated comparing observed versus projected as we could compare the means across the TSA and study where pixels matched and didn't match. Incorporating these metrics into landscape level simulations is also a realistic goal for this tool (ie projecting forest road density across a landscape) so a goal was to therefore see how well the model did at simulating these metrics when compared to the observed landscape.

Many spatial stochastic models don't include road projections at all in their simulations (Bergeron et al., 2017; DeLong & Tanner, 1996; Naderializadeh & Crowe, 2020; Perera & Cui, 2010). Our model could be relatively easily incorporated, or applied retroactively, to similar spatial stochastic simulations such as these. For large-scale projects such as the Western Boreal Initiative (Environment Canada, date?) that simulate many complex factors across a landscape, our forest road projection methods could be incorporated as one element within the overall landscape simulations.

-The road presence metric is sensitive to small differences in road location while the road density metric is sensitive to variations in the curves of tightly packed roads within grid cells that cannot be modeled using this algorithm.

# Conclusion

The forest road network projection model presented here provides an effective way to project forest road networks that are suitable for large scale landscape simulations with relatively little effort. This model, however, is not suitable for strategic planning. The results from our projections in our study area overall matched up adequately with the observed present day forest road networks, with major discrepancies being attributed to issues in the available road and cutblock data. These discrepancies would not be issues in future landscape simulations, only when assessing accuracy. In areas where the quality of the data was high, projections matched well with the observed network. Our metrics were able to be projected effectively across a large landscape and could be useful indicators of impacts on wildlife habitats in future simulations.

This model was developed with the goal of being simple to use, readily accessible, and relatively accurate across a large landscape. With minimal input parameters, complexity, and computational power, one can project future forest road networks using this tool across large areas which can aid in the assessment of potential impacts of forestry disturbance on wildlife and habitat over a large spatial scale. With land use activities transforming a large proportion of the planet's land surface and becoming an issue of global importance (Foley et al., 2005), there is an increasing need to improve and build upon landscape level models in order to properly manage and protect remaining natural habitats. Land-use activities, primarily for agricultural expansion and timber extraction, have caused a net loss of \~7 to 11 million km2 of forest in the past 300 years (Foley et al., 2005). With only 7% of the planet's roadless areas being larger than 100 square kilometers, there is a need to protect key areas which sustain key refugia for biodiversity from fragmentation and degradation (Ibisch et al., 2016). The introduction of this widely applicable and user-friendly forest resource road model is a step in the right direction for providing more tools to land managers and planners who are interested in assessing the potential impacts of road development over large landscapes.
-->
```
# Acknowledgements

<!-- The following line inserts a page break  -->

\newpage

# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::

\newpage

# Appendix

## Road network projection method details

Various optimization and simulation techniques have been used for projecting forestry roads into the future and across landscapes, however, we focused on the simulation methods that link multiple harvest units (a.k.a cutblocks) to an existing road network for strategic purposes. Dean (1997) described this road projection problem as the multiple target access problem (MTAP), where the objective is to find the minimum-cost locations for new roadways that link forested stands or landings (i.e., log deck) to the existing road network. We used four methods for solving the MTAP in the roads package. These methods represent a gradient of computational complexity and operational detail, starting with the least complicated or the snapping approach, followed by the least cost paths approach (LCP), dynamic least cost paths (DLCP) approach and finally, the minimum spanning tree approach (MST). In this paper, we focus on the LCP, DLCP and MST approaches given their assumptions are well aligned with how forestry professionals would strategically design road networks.

The LCP approach solves the MTAP by decomposing the problem into several smaller problems called single target access problems (STAP). For each STAP, a least cost path from a single source to sink was solved using Dijkstra's shortest path algorithm (1959). Dijkstra's algorithm minimizes the distance between a landing and the current road network, subject to costs or penalties incurred from road construction and travel (the details of this process are described later in the section "weighted graph"). Witht the LCP approach each STAP is solved independently but for the DLCP approach each STAP was then solved sequentially, with the newly projected roadway updating the existing road network and subsequently the costs of road construction. This method was first developed by Anderson and Nelson (2004) and provides a feasible solution to the MTAP, however the projected network is sensitive to the ordering of the STAP. They recommended a heuristic for connecting the landings and finding optimal branch locations to deal with this sensitivity.

The MST approach extends the LCP approach by providing a heuristic for linking landings or evaluating road branching opportunities. Dean (1997) showed that heuristics with branch evaluation were able to reproduce 80% of the observed road locations in their study area. Our MST approach has three steps towards evaluating branch locations while projecting roads: 1) estimate the least cost paths that link each of the landings and the least cost paths that link each landing to the existing road network, 2) creating a weighted graph where each node is either a landing or point on the existing road network and each edge or arc is weighted by the costs estimated in the previous step and 3) solving the minimum spanning tree for this graph. The minimum spanning tree was solved using Kruskal's algorithm (1956) where every node in the graph was linked to form a tree such that the sum of edge weights is minimized, and the links do not form a loop. This method was most similar to Clark et al. (2000) approach which used a minimum spanning tree to project simple road networks during harvest scheduling. An important difference was that they based the edge weights on spatial Euclidean distance, whereas the MST approach used the costs estimated from least cost paths.

## Weighted graph

A mathematical weighted graph consisting of nodes and edges was used to parameterize either Kruskal's or Dijkstra's algorithms. When solving least cost paths using Dijkstra's algorithm, each node in the graph corresponded to a pixel in a raster of our study area (1 ha resolution). Whereas, in the graph used for solving the minimum spanning tree via Kruskal's algorithm, each node represented either a landing or a point on the existing road network. Therefore, a node can be represented by any one of three attributes in the forest road network: (i) a landing, (ii) a point on an existing road, or (iii) an intermediate point. The landing nodes represent log decks or sources of timber and the point on the existing road is the sink where the timber will end up. The intermediate points are plausible locations to construct a road and are thus free of barriers like major water bodies. The edges connecting the nodes follow an "octagonal" neighbourhood or allow a maximum of eight possible edges for a given node, with diagonal edges having a higher cost. Thus, our methods utilize a grid pattern which does not support curvature or switchbacks in road design as required in operational road design. Therefore, our road projection methods are for strategic modelling purposes only. Edges are assigned weights which penalize the algorithm to account for various impedance and road construction costs. When solving least cost paths, a cost surface raster was used. The pixels of the cost surface raster corresponded to nodes in the weighted graph and thus the edge weight was the average cost between the two nodes or pixels. When solving the minimum spanning tree, the edge weight corresponded to the total cost of the least cost path between the two nodes.

## Coarse resolution results

```{r get-data2}
data_path_drvd <- "analysis/data/derived_data/TSA27_1000"

# load csv
meanTable2 <- read.csv(here(data_path_drvd, "mean_table.csv")) %>% 
  mutate(resolution = "1000")

matchData2 <- read.csv(here(data_path_drvd, "agree_table.csv")) %>% 
  mutate(resolution = "1000")

meanTable <- meanTable %>% mutate(resolution = "100") %>% bind_rows(meanTable2) %>% 
  filter((method != "dlcp"| is.na(method)) & (sampleType != "cutOnly" | is.na(sampleType)))

matchData <- matchData %>% mutate(resolution = "100") %>% bind_rows(matchData2) %>% 
  filter(method != "dlcp", sampleType != "cutOnly")

```

```{r figA1, fig.height=12, fig.width=fig_widths["two"], fig.cap="Proportional difference of projected mean from observed mean road metrics using different projection methods for the fine resolutiom (1 ha) and coarse resolution (100 ha) cost rasters. Metrics were summarised within cutblocks, outside cutblocks, and overall. Values greater than 0 indicate the projection overestimated the metric and negative values indicate an underestimation."}
# organize data for ggplot
meanTable_long <- meanTable %>% dplyr::select(-runTime, -order) %>% 
  pivot_longer(-c(sampleType, sampleDens, areaMean, resolution, method),
               names_to = "metric", values_to = "response")%>%
  mutate(sampleType = ifelse(sampleType == sampleDens, NA_character_, 
                             sampleType),
         sampleDens = paste(method, sampleType, sampleDens) %>% 
           factor(levels = c("mst NA centroid",
                             "NA NA observed",
                             "mst random low sample density",
                             "mst regular low sample density",
                             "mst random high sample density",
                             "mst regular high sample density",
                             "dlcp regular high sample density",
                             "NA klementQGIS", 
                             "NA NA NA"),
                  labels = c("MST centroid", 
                             "Observed",
                             "MST random low density",
                             "MST regular low density",
                             "MST random high density",
                             "MST regular high density",
                             "DLCP regular high density",
                             "Hardy QGIS",
                             "Cutblocks only")),
         metric = factor(metric,
                         levels = c("roadDensityMean", "roadPresenceMean",
                                    "distanceToRoadMean",
                                    "forestryDisturbanceMean",
                                    "roadDisturbanceMean"),
                         labels = c("Road\ndensity", "Road\npresence",
                                    "Distance\nto road",
                                    "Forestry\ndisturbance\nfootprint",
                                    "Road\ndisturbance\nfootprint")))


observed_values <- filter(meanTable_long, sampleDens == "Observed")
projected_values <- filter(meanTable_long, sampleDens != "Observed")

# get proportional difference from observed
prop_dif <- projected_values %>% 
  left_join(observed_values %>% select(areaMean, metric, resolution, response),
            by = c("areaMean", "metric", "resolution"), 
            suffix = c("_proj", "_obs")) %>% 
  mutate(prop_dif = (response_proj-response_obs)/response_obs,
         areaMean = factor(areaMean, labels = c("Cutblocks", "Outside\ncutblocks",
                                                "Overall")))

prop_dif %>% 
  ggplot(aes(x = sampleDens, prop_dif, fill = resolution))+
  geom_hline(aes(yintercept = 0), color = "grey")+
  geom_col(position = position_dodge2(preserve = "single",
                                      width = 0.75))+
  facet_grid(areaMean + metric ~"")+
  theme_classic()+
  scale_fill_manual(values = met.brewer(pal_nm), labels = c("1 ha", "100 ha"))+
  theme(text = element_text(size = 10), axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        strip.background.x = element_blank(),
        legend.position = "right",
        axis.text.x=element_text(size=11, angle=50, vjust=1, hjust=1))+
  coord_flip()+
  labs(fill = "Resolution")

```

```{r figA2, fig.height=4.5, fig.width=fig_widths["mid"], fig.cap="Comparison of performance metrics for each projection method variant for the fine resolutiom (1 ha) and coarse resolution (100 ha) cost rasters. F measure is the harmonic mean of precision and sensitivity, precision is the proportion of predicted roads that are observed roads and sensitivity is the proportion of observed roads that were correctly predicted."}

matchData_sum <- matchData %>% ungroup() %>%
  mutate(agreement = factor(agreement,
                            levels = c("False negative", "False positive",
                                       "Agree roaded","Agree roadless",
                                       "Pre-existing roads")),
         sampleDens = paste(method, sampleType, sampleDens) %>%
           str_replace("1e-06", "low density") %>%
           str_replace("1e-05", "high density") %>%
           str_replace("centroid low density", "centroid") %>%
           str_replace("klementQGIS NA", "klementQGIS") %>%
           factor(levels = c("mst centroid",
                             "mst random low density",
                             "mst regular low density",
                             "mst random high density",
                             "mst regular high density",
                             "dlcp regular high density",
                             "NA klementQGIS"),
                  labels = c("MST centroid", 
                             "Random low density",
                             "Regular low density",
                             "Random high density",
                             "Regular high density",
                             "DLCP regular high density",
                             "Hardy QGIS")),
         metric = factor(metric,
                         levels = c("roadPresence",
                                    "forestryDisturbance",
                                    "roadDisturbance"),
                         labels = c("Road presence",
                                    "Forestry disturbance\nfootprint",
                                    "Road disturbance footprint"))) %>%
  group_by(metric, sampleDens, agreement, resolution) %>%
  summarise(count = sum(count), .groups = "drop_last") %>%
  mutate(perc = count/sum(count)*100)

# performance table
perf_tbl <- matchData_sum %>% 
  pivot_wider(c(metric, sampleDens, resolution), names_from = agreement, 
              values_from = count) %>% 
  mutate(sensitivity = `Agree roaded`/(`Agree roaded` + `False negative`),
         precision = `Agree roaded`/(`Agree roaded` + `False positive`),
         F_measure = (2*precision*sensitivity)/(precision+sensitivity)) %>% 
  select(resolution, metric, sampleDens, sensitivity, precision, F_measure) 

perf_tbl_rng <- perf_tbl %>% group_by(metric, resolution) %>% 
  summarise(rng_F = range(F_measure) %>% round(3) %>% paste0(collapse = " - "), .groups = "drop") %>% pull(rng_F, name = metric)

perf_tbl %>% 
  pivot_longer(c(sensitivity, precision, F_measure), names_to = "perf_meas",
               values_to = "value") %>% 
  mutate(perf_meas = factor(perf_meas,
                            labels = c("F measure", "Precision", "Sensitivity"))) %>% 
  ggplot(aes(sampleDens, value, fill = resolution))+
  geom_col(position = position_dodge2(preserve = "single",
                                      width = 0.75))+
  scale_fill_manual(values = met.brewer(pal_nm), labels = c("1 ha", "100 ha"))+
  facet_grid(metric ~ perf_meas)+
  coord_flip()+
  ylim(0, 1)+
  theme_classic()+
  labs(y = "Performance", x = NULL, fill = "Resolution")

```

## Fort Nelson map

```{r ftNelson, cache=TRUE, fig.height=6, fig.width=fig_widths["two"], fig.cap="Existing roads in Fort Nelson. Cost based road projection methods are not expected to be useful in areas where roads are built for purposes other than accessing a target location at minimal cost. For example, in the Northeast corner of the Fort Nelson Timber Supply Area seismic lines show a different pattern than foresty roads."}
ftN_roads_obs <- read_sf(here("analysis/data/derived_data/combined_ft_nelson_roads.gpkg"))

# only show top right corner
bb <- st_bbox(ftN_roads_obs) 

bb[["xmin"]] <- bb[["xmax"]] - (bb[["xmax"]] - bb[["xmin"]])/2
bb[["ymin"]] <- bb[["ymax"]] - (bb[["ymax"]] - bb[["ymin"]])/2

ftN_roads_obs_NE <- st_crop(ftN_roads_obs, bb)

tm_shape(ftN_roads_obs_NE, is.master = TRUE)+
  tm_lines()
```

\newpage

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies:

```{r colophon, cache = FALSE}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
