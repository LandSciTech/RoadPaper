---
title: "Development and assessment of automated forest road projection methods using performance metrics relevant for wildlife"
author:
  - name: Josie Hughes
    email: josie.hughes@ec.gc.ca
    institute: [ECCC]
    correspondence: true
    equal_contributor: "yes"
    orcid_id: 0000-0001-7875-9015
  - name: Sarah Endicott
    email: sarah.endicott@ec.gc.ca
    institute: [ECCC]
    correspondence: false
    equal_contributor: "yes"
  - name: David Lapins
    email: david.lapins@pc.gc.ca
    institute: [ECCC]
    correspondence: false
  - name: Kyle Lochhead
    email: Kyle.Lochhead@gov.bc.ca
    institute: [FLNR]
    correspondence: false
  - name: Gregory Paradis
    email: gregory.paradis@ubc.ca
    institute: [UBC]
    correspondence: false

institute:
  - ECCC: Landscape Science and Technology Division, National Wildlife Research Center, Environment and Climate Change Canada, Ottawa, ON, Canada  
  - FLNR: Ministry of Forest Lands, Natural Resource Operations and Rural Development, Victoria, BC, Canada
  - UBC:  Faculty of Forestry, Department of Forest Resources Management, The University of British Columbia, Vancouver, BC, Canada 

date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      number_sections: no
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
bibliography: Roads.bib
csl: "../templates/chicago-author-date.csl" # Insert path for the bib-style
keywords: |
   forest roads, road networks, forest dynamics, spatially explicit modeling, predictive ecology, least cost paths
editor_options: 
  chunk_output_type: inline
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

<!-- With the following code you can access and display values from the yml header above. -->

<!-- Link to data here: https://drive.google.com/file/d/179lw6MPK4l3xGmded9kofzJkB6VlJVb9/view?usp=sharing -->

```{=html}
<!-- TO DO CJFR guidelines to note:
* 6000 words, 50 references - need to remove ~30 refs
* abstract 200 words
* page #s
* double spacing
* affiliation - insitution, city, prov, country
* CMJE definition of authorship - need CRedit author contribution statement
* need funding statement, data availability statement, competing interests
* review figure guidance
-->
```
Keywords: `r rmarkdown::metadata$keywords`

[To do list](https://docs.google.com/document/d/1msHZuJGv0C67Avbl67YXm_P6fBSAvGw-m9qIzNDic64/edit?usp=sharing)

<!-- The following code chunk defines some general settings how code chunks should behave. -->

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  dev = "tiff",
  dev.args=list(compression="lzw"),
  dpi = 300
)
# Setting to avoid re-running projections
rerun <- TRUE
```

\newpage

# Abstract

Despite a rapidly growing body of evidence of complex and varied impacts of road networks on wildlife and other forest values, and the increasing use of spatial stochastic models for forecasting impacts of forest disturbance across regions, very few spatial stochastic projections of forest disturbance dynamics have included automated road network projections, in part because tools suited for this purpose have not been available. Hardy et al. [-@hardy_landis-ii_2023] partially addressed this need with a LANDIS-II extension. As a complementary and comparable alternative, we provide implementations of simple iterative least cost path and minimum spanning tree methods with grade penalties in an open source R package that can be easily integrated into R workflows and modelling frameworks used for forecasting forest change in Canada and elsewhere. Grade penalties improve performance in a mountainous region of British Columbia, as does our minimum spanning tree method. However, the minimum spanning tree method requires more computing time and memory, so users must weigh the benefits of improved performance against computational costs. Our road network simulation methods can improve projections of anticipated resource development impacts on wildlife across large areas, and we hope that more easily useable open source implementations will encourage integration of resource roads into forest change projections.

# Study Implications

This study offers open source tools for automated forest road network projection that are suited for integration into modelling frameworks used to project the implications of forest change for wildlife. We assess road network projection methods using ecologically relevant metrics, and show that grade penalties can improve performance in a topographically complex landscape. These tools can help improve projections of the cumulative effects of natural and anthropogenic disturbances on wildlife in an era of rapid change.

<!-- The actual document text starts here: -->

# Introduction

The impacts of roads on wildlife are complex and varied. Mortality risk and stress on or near roads can be elevated due to vehicle collisions, hunting pressure, predation, noise and other stressors, but roads can also provide food, facilitate movement, and provide refuge [@hill_review_2021; @trombulak_review_2000; @fahrig_effects_2009]. In Canadian forests, there is ample evidence of linear features attracting predators such as bears (*Ursus americanus*, *Ursus arctos*) and wolves (*Canis lupus*) seeking food or easy movement, while repelling prey such as woodland caribou (*Rangifer tarandus caribou*) and moose (*Alces americanus*) [@dickie_corridors_2020; @polfus_identifying_2011; @mumma_predation_2018; @beauchesne_disentangling_2013; @leblond_avoidance_2013; @laurian_interactions_2012; @st-pierre_stairway_2022]; there is also evidence of predators avoiding features heavily used by humans [@muhly_human_2011; @whittington_towns_2022; @proctor_effects_2020]. Changes in mortality risks, habitat quality, and connectivity associated with anthropogenic disturbance can in turn alter use and movement patterns [@tucker_moving_2018; @apps_factors_2006; @proctor_effects_2020], demography and population viability [@johnson_science_2020; @decesare_linking_2014; @barrientos_lost_2021; @apps_spatial_2013; @pinard_calving_2012; @fahrig_effects_2009; @lochhead_linking_2022; @apps_spatial_2013; @proctor_effects_2020], and genetics [@habrich_varying_2021]. Roads can also facilitate spread of invasive species [@riitters_landscape_2017], and enable other development activities [@johnson_growth-inducing_2020]. Impacts on wildlife persist after roads are no longer driveable as they continue to be used by wildlife and soil compaction impedes vegetation recovery [@st-pierre_drivers_2021; @lacerte_determinants_2021]. Measures of road impacts are important for informing wildlife management decisions, and there is therefore a need to include roads in ecological forecasting models.

Increasingly rapid environmental change, improvements in available cyberinfrastructure, and development of open source data, tools and methods have contributed to growing interest in ecological forecasting models [@bodner_bridging_2021; @dietze_ecological_2017; @mcintire_perfict_2022]. In particular, forest landscape models that can account for harvest, fire, and other disturbances are increasingly used to project the cumulative effects of climate change and forest management [@petter_how_2020; @albrich_simulating_2020; @hof_editorial_2021; @tremblay_harvesting_2018; @snell_importance_2018; @daniel_incorporating_2017; @stewart_climate-informed_2023; @micheletti_assessing_2021; @leblond_there_2022; @bouderbala_long-term_2022; @barros_empowering_2023; @labadie_global_2023], building on a rich history of spatial-stochastic models of forest growth and succession following disturbance [@sturtevant_understanding_2021]. Despite the importance of roads for wildlife, very few of these projections have included road networks [@labadie_global_2023; @leston_quantifying_2020]. For example, in a recent collection of articles focused on "Using Landscape Simulation Models to Help Balance Conflicting Goals in Changing Forests" [@hof_editorial_2021], only one includes a road projection [@leston_quantifying_2020]. In the absence of road projection methods, researchers are left to conservatively infer the amount and randomly assign the location of roaded areas [e.g. @johnson_witnessing_2015].

While road projections are not typically integrated with forest landscape models, methods have been developed to support harvest planning [@anderson_projecting_2004; @clark_three-stage_2000; @dean_finding_1997; @epstein_combinatorial_2006; @meignan_heuristic_2012; @stuckelberger_improved_2007], and some forest management planning software suites [e.g. @remsoft_remsoft_nodate; @spatial_planning_systems_patchworks_nodate] include road projection tools. These methods have occasionally been incorporated into forest landscape models [e.g. @leston_quantifying_2020] but they were not designed for that purpose. Existing road projection algorithms contained in proprietary closed-source software are difficult to fully integrate into stochastic models, which often require numerous replicates [@sturtevant_understanding_2021; @de_pellegrin_llorente_recognizing_2017]. Further, costs of licensing are generally prohibitive, deploying large commercial software suites designed for desktops to cloud or high performance computing resources is difficult or impossible, and closed-source software is often not sufficiently transparent for use in research. At the operational scale, road planning methods and tools [e.g. @anderson_projecting_2004; @clark_three-stage_2000; @dean_finding_1997; @epstein_combinatorial_2006; @meignan_heuristic_2012; @stuckelberger_improved_2007; @remsoft_remsoft_nodate; @spatial_planning_systems_patchworks_nodate] may produce more accurate road projections but the cost of scaling their inputs to larger spatial extents can be prohibitive in contexts where a coarser approximation of the road network may suffice. There is a need for open-source road network projection tools that can be integrated into the open modular platforms that are used for large-scale stochastic landscape simulations [@scheller_design_2007; @barros_empowering_2023; @daniel_state-and-transition_2016].

Automated road projection methods often rely on more general purpose route finding algorithms that identify paths among points in a mathematical graph that minimize some measure of cost [@deo_graph_2016]. General-purpose open source tools for graph analysis [e.g. @csardi_igraph_2006] include methods for building graphs from adjacency matrices, finding “least cost paths” between pairs of points, and finding a least cost network of routes (i.e. a minimum spanning tree) that connects a larger set of points [@deo_graph_2016]. More domain-specific tools [e.g. @van_etten_r_2017] can help make these general-purpose tools easier to use and apply in specific contexts. Promising simple graph-based options for integrating forest road network projections into large scale stochastic projections of forest change include an iterative least cost path method developed by Hardy et al [-@hardy_forest_2019; -@hardy_landis-ii_2023], and least cost path and minimum spanning tree algorithms used to reconstruct road development history in British Columbia [@lochhead_demo_2018; @lochhead_linking_2022]. The former method is available as QGIS and LANDIS-II extensions, and the latter is embedded in a larger open source modelling project that is specific to British Columbia [@muhly_castor_nodate]. The Hardy et al. [-@hardy_landis-ii_2023] tool is designed for integration with other components of the LANDIS-II modelling framework [@scheller_design_2007; @labadie_global_2023], but none of the existing implementations can be easily integrated into the full variety of modelling frameworks used for forecasting forest change in Canada and elsewhere [e.g. @barros_empowering_2023; @daniel_state-and-transition_2016].

We acknowledge that using graph analysis methods to simulate roads is not new, and that other variants of iterative least cost path (or source-to-closest-target) and minimum spanning tree algorithms have been proposed and explored [@picard_finding_2006; @anderson_projecting_2004; @stuckelberger_improved_2007; @clark_three-stage_2000]. Anderson and Nelson (2004) considered horizontal and vertical alignment, turn radius and junction angles, and switchback spacing for a relatively small 7500 ha area. However, for wide-ranging wildlife such as boreal caribou projections at much larger spatial scales are needed, and constructing and analyzing graphs for large landscapes is memory intensive and computationally demanding. We therefore focus here on assessing the adequacy of methods that minimize memory and computational requirements by setting construction costs (represented as edge weights on a simple undirected graph) from values of adjacent locations on a single user-supplied input raster. This constraint permits penalization of steep grades as suggested by Anderson and Nelson [-@anderson_projecting_2004], but does not permit other aspects of their method. We compare a simple grade penalty approach to the method of calculating edge weights from a cost surface raster used by both Hardy et al. [-@hardy_forest_2019; -@hardy_landis-ii_2023] and Lochhead et al. [-@lochhead_linking_2022]. We argue that if these simple algorithms can produce adequate outcomes for landscape-level stochastic ecological forecasting then the additional burden of more complex realistic algorithms is not warranted in that context.

To help address the need for forest road network projection tools that can be easily integrated into large spatial scale stochastic models of forest change we implemented two alternative approaches (described in further detail in the next section) in an open source R package: 1) iterative least cost paths and 2) a minimum spanning tree [@lochhead_demo_2018; @lochhead_linking_2022]. We also consider two different methods for determining the cost of road building: 1) a simple elevation driven cost surface and 2) a simplified version of the grade penalty approach suggested by Anderson and Nelson [-@anderson_projecting_2004]. Our intention was to produce outputs comparable to Hardy et al. [-@hardy_forest_2019; -@hardy_landis-ii_2023] with a tool that can be used in modelling contexts outside of QGIS/LANDIS, and can serve as a more easily modifiable starting point for further refinement and development. We compared the ability of these methods and Hardy's method [-@hardy_forest_2019; -@hardy_landis-ii_2023] to reconstruct observed forest road network development since 1990 in a mountainous region of British Columbia. The adequacy of a road network projection method depends on the purpose of the projection, so it is important to select performance metrics that reflect the purpose. Given our interest in projecting impacts on wildlife we focused on several common predictors of the impacts of roads on wildlife, including distance to roads [@labadie_global_2023], buffered disturbance footprint [@johnson_science_2020; @ibisch_global_2016; @lochhead_linking_2022; @polfus_identifying_2011; @labadie_global_2023; @stewart_climate-informed_2023], and road density [@apps_factors_2006; @apps_spatial_2013; @serrouya_time_2017].

We expect these simple graph-based road projection methods to represent a reasonable compromise between computational cost and realism for stochastic projections on large landscapes, and we expect our method for penalizing steep grades to yield more realistic road networks in steep terrain relative to our simple cost method. We do not have a similarly strong hypothesis about whether minimum spanning tree projections are likely to be more or less realistic than iterative least cost path projections. We expect minimum spanning tree projections to be more accurate when resource roads are designed to simultaneously access multiple sites at the lowest cost. However, real road networks are built over time, and it is not necessarily true that they are designed to minimize overall cost, so it is possible that larger more costly road networks built by iterative least-cost path algorithms will be more realistic.

```{=html}
<!-- TO DO:
- more thorough review of SMC & grizzly papers
- summarize road metric types used in cited papers more systematically.
-->
```
```{=html}
<!--
See notes here:
https://docs.google.com/document/d/1UQ_iC69QX0qX86NM6zSSQ036CgslN-uCXCdBY-4nU5M/edit
Effects of roads on wildlife include increased mortality from various types of encounters with humans, alterations in behaviour and interactions among predators and prey, and spread of invasive species (Trombulak and Frissel 2001). In boreal forests and coniferous forests of the Columbia and Rocky mountains, notable impacts of logging roads include facilitation of movement by wolves (Mumma et al. 2018; Dickie et al. 2020), attraction of bears to roadside food resources (Roever et al. 2010; Bastille-Rousseau et al. 2011; Dickie et al. 2020), increased mortality caused by humans near roads and trails (Roever et al. 2010), and avoidance by ungulates (Laurian et al. 2015; Dickie et al. 2020). Forest dwelling boreal woodland and mountain caribou avoid roads leading to a loss of available habitat (Polfus et al. 2011; Dickie et al. 2020), and suffer increased mortality near roads (Bastille-Rousseau et al. 2011; Mumma et al. 2018). At a range scale, survival and recruitment of boreal caribou declines with anthropogenic disturbance (Johnson et al. 2020). Eight herds of Southern Mountain Caribou have been extirpated or likely extirpated, and remaining herds are considered Endangered by COSEWIC  and listed as threatened under the Canadian Species at Risk Act (SARA) (Palm et al. 2019). Most boreal caribou populations with ranges that include intensive forest management activity are not self-sustaining (ECCC 2011; Johnson et al. 2020), and boreal caribou are also listed as threatened under SARA.

Nonlinear responses of elk to road density (Frair et al. 2008). Black bear responses to roads vary with road type (Zeller et al. 2020), and selection for roadside vegetation can increase neonatal boreal woodland caribou mortality in areas near roads . 
For more careful reading: Flyal et al. 2019; Jaeger et al. 2005; Laurance et al. 2014; Psaralexi et al. 2017; Apps et al 2014; Beyer et al. 2014; Blagdon and Johnson 2021; Suzuki and Parker 2016; Fahrig and Rytwinski 2009; Coffin et al. 2021; Crist et al. 2005; Grantham et al. 2020;Johnson et al. 2019; Meijer et al. 2018; Langeveld et al. 2009

<!-- value of roadless areas: [@ibisch_a_2016; @talty_conservation_2020; @psaralexi_importance_2017] -->

<!-- forest mgmt planning models: [@depellegrinllorente_recognizing_2017] -->

<!-- other of interest: caribou habitat metric [@whitman_a_2017] -->

<!-- Resource extraction, such as forest harvesting, is the main driver of road construction in much of Canada's forested area. In British Columbia, over 600 000 kilometers of resource roads make up the vast majority of the province's total road network (83%) (Environmental Reporting BC, 2018; Forest Practices Board, 2015). Over 75% of resource roads in the province were built by the forest industry (Forest Practices Board, 2015). -->

<!-- Forest simulation models generally either fall into two categories: deterministic and stochastic (Boychuk et al., 2009; Helmes & Stockbridge, 2011). -->

-->
```
# Methods

## Study Area and Data

We chose the Revelstoke timber supply area (TSA 27) in British Columbia, Canada as an assessment area because it is mountainous (Figure \@ref(fig:study-area)), containing approximately 38% non-forested land [@british_columbia_ministry_of_forests_revelstoke_2022] where road building is challenging. Thus, the area provides opportunities to observe the behaviour of road projection algorithms in steep complex terrain. Forestry is the dominant resource extraction activity and much of the road network was built to access forest harvest cutblocks, allowing projection of the road network from historic forest harvest data. The Revelstoke TSA includes portions of the Monashee and Selkirk mountain ranges, and is bisected by the Columbia River. At low to mid-elevations, forests of the interior cedar-hemlock biogeoclimatic zone [@british_columbia_ministry_of_forests_revelstoke_2022] include remnants of rare old growth inland temperate rainforest [@government_of_canada_parks_canada_agency_old_2017]. At higher elevations, forests are dominated by Engelmann spruce and subalpine fir [@british_columbia_ministry_of_forests_revelstoke_2022]. The area is within the ancestral territories of the Ktunaxa Nation, Secwepemc Nation, Syilx and Sinixt [@british_columbia_ministry_of_forests_revelstoke_2022]. Two of six southern mountain woodland caribou herds in the area have been extirpated, and the remaining herds are considered Endangered by the Committee on the Status of Endangered Wildlife in Canada and listed as threatened under the Canadian Species at Risk Act [@palm_long_2020; @british_columbia_ministry_of_forests_revelstoke_2022; @environment_canada_recovery_2014]. Mountain caribou avoid roads leading to a loss of available habitat [@polfus_identifying_2011; @apps_factors_2006], suffer increased mortality near roads [@apps_spatial_2013], and decline in abundance as the footprint of roads and cutblocks increases [@lochhead_linking_2022]. Roads also alter grizzly bear habitat use, home range selection, movements, population fragmentation, survival, reproductive rates, population density, trends, and conservation status [@proctor_effects_2020].

```{=html}
<!--        TO DO: consider these comments from Kyle: Need a description about road development. In BC, forestry roads are developed by forest licensees under a timber harvesting permit. Various considerations go into road development including soils, grade, and economics. What type/classification of roads are you looking at (primitive roads, paved roads, etc). What’s the maximum grade? ---can find a lot of this verbiage in the Interior Appraisal Manual. How are they maintained – do they last forever -see Auditor General Report 
•        How much of the Revelstoke TSA overlaps with caribou range? Elevation? Climate? Flora/Fauna?
•        Maybe add a table of descriptive statistics presenting information about roads in the Revelstoke TSA and the other TSAs you mention? By Caribou Range? – road density, road length, cutblock area, cutblock density, etc
-->
```
```{r setup2}
library(sf)
library(ggplot2)
library(dplyr)
library(stringr)
library(tidyr)
library(purrr)
library(MetBrewer)
library(here)
library(tmap)
library(cowplot)
library(ggspatial)

#devtools::install_deps(here()) #try this if the next line is giving trouble.
devtools::load_all(here())

#set paths
data_path_raw <- "analysis/data/raw_data/"
data_path_drvd <- "analysis/data/derived_data/TSA27_real_cuts"

pal_nm <- "Redon"

fig_widths <- c(min = 1.18, single = 3.48, mid = 5.51, two = 7.16)
```

```{r prepStudyArea, cache=TRUE}

tsaBoundary <- read_sf(here(data_path_raw, "tsa27_boundaries.gpkg"))
#weight raster layers
tsaCost <- terra::rast(here(data_path_drvd, "old cost/input_cost.tif"))
dem <- terra::rast(here(data_path_drvd, "dem/input_cost.tif"))

#tsaCost[tsaCost==65000]=NA
dem[dem==-65000]=NA

tsaCost <- terra::mask(tsaCost, terra::vect(tsaBoundary))
dem <- terra::mask(dem, terra::vect(tsaBoundary))

canada <- geodata::gadm("CAN", level = 1, path = here(data_path_raw))

canada <- canada %>% 
  st_as_sf() %>% 
  filter(COUNTRY == "Canada") %>% 
  st_transform(st_crs(tsaBoundary)) %>% 
  st_simplify(dTolerance = 10000)

# using ggspatial because tmap doesn't work with both multiplots and insets
tsaBound <- st_union(tsaBoundary)

dem_map <- ggplot() + 
  layer_spatial(dem) +
  geom_sf(data = tsaBound, fill = NA) +
  annotation_scale(width_hint = 0.4) +
  scale_fill_continuous(low = "white", high = "black",
                        na.value = NA)+
  theme_void()+
  theme(plot.background = element_rect(colour = NA, fill = "white"))+
  labs(fill = "Elevation")

cost_map <- ggplot() + 
  layer_spatial(tsaCost) +
  geom_sf(data = tsaBound, fill = NA) +
  annotation_north_arrow(style = north_arrow_orienteering(fill = c("black", "black")), height = unit(1, "cm"), width = unit(0.75, "cm")) +
  scale_fill_continuous(low = "white", high = "black",
                        na.value = NA)+
  theme_void()+
  theme(plot.background = element_rect(colour = NA, fill = "white"))+
  labs(fill = "Cost")

can_map <- ggplot() + 
  geom_sf(data = canada %>% st_transform(crs = "+proj=lcc +lat_1=20 +lat_2=60 +lat_0=40 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"), fill = NA) +
  geom_sf(data = st_buffer(tsaBound, 10000) %>% st_transform(crs = "+proj=lcc +lat_1=20 +lat_2=60 +lat_0=40 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"), 
          fill = met.brewer(pal_nm, 1)) +
  theme_void()+
  theme(panel.border = element_rect(colour = "black", fill = NA))

out_map <- plot_grid(cost_map, dem_map)+
  draw_plot(can_map, x=1.09, y=0.945,
            width = 0.35, height=0.2,
            hjust= 1, vjust = 1)

save_plot(here("analysis/figures/Figure1_StudyArea_both.tiff"),
          out_map,
          compression = "lzw",
          dpi = knitr::opts_chunk$get("dpi"),
          base_width = fig_widths["two"],
          base_height = 6*0.9)
```

Road network data was obtained by combining the digital road atlas [@data_bc_digital_2021] and forest tenure road [@british_columbia_ministry_of_forests_lands_natural_resource_operations_and_rural_development_forest_2021] data sets for British Columbia. To avoid situations where the same road was included in both data sets with slightly different coordinates, we removed all roads from the digital road atlas that were within 50 m of forest tenure roads. The existing road network, used as the starting point for projections, was created by filtering out forest tenure roads with an award date greater than 1990. We assumed everything in the digital road atlas was built before 1990. Cutblock information was obtained from the Harvest Areas of BC (Consolidated Cutblocks) dataset [@government_of_british_columbia_harvested_2021], compiled from provincial Forest Cover, the RESULTS Reporting system, Forest Tenure applications, and satellite imagery using change detection processes. Forest harvest cutblocks with harvest years greater than 1990 were filtered and used as targets for the projections. We further filtered cutblocks that contain observed roads from those that do not to reduce errors associated with open areas that have been misidentified as cutblocks.

Following the Interior Appraisal Manual of BC, we assume the base cost of construction per kilometer of road is a linear function of slope [@government_of_british_columbia_interior_2021], and that road construction across major water bodies is prohibitively expensive (Table \@ref(tab:cost-tbl)). Existing roads are assigned a construction cost of 0. We compare two methods for integrating these costs into the cost of connections between adjacent raster cells. In the "simple cost" method, we first calculate a slope raster from a digital elevation model, then calculate an input cost raster that depends on slope (Table 1, Supplement 1-1). The cost of the connection between two adjacent cells is simply the mean of the cost raster value at each of those cells, adjusted for euclidean distance between the cells to penalize longer diagonal road segments. In the "grade penalty" method (Supplement 1-1), we use the same construction costs (Table 1), but we calculate the cost of a connection between neighbouring cells from the elevation difference between the cells, using an elevation raster as input (Figure \@ref(fig:study-area)b), and penalizing edge grades as suggested by Anderson and Nelson (2004). The most important difference between these two approaches is that grade is a property of the edge between two nodes in the grade penalty method, while slope is a property of each node in the simple cost method. When slope is a node property, the same slope penalty applies regardless of the alignment of the road segment. Calculating grade from the difference in elevation between pairs of nodes allows us to penalize roads that follow elevation contours differently from roads that go up or down. The road construction cost and elevation rasters consist of 1.7 million pixels with a resolution of 1 ha. We examined sensitivity to pixel resolution by comparing results from 1 ha and 100 ha weight rasters. We did not consider finer resolutions because stochastic forest landscape models typically simulate dynamics at resolutions \>= 1 ha.

All data sets were accessed using the `bcdata` R package and filtered to the extent of the Revelstoke Timber Supply Area [@teucher_bcdata_2021]. These data sets are continuously updated so we have stored the versions used in our analysis in an Open Science Framework repository [@endicott_assessment_2024]. We were not granted permission to share the digital road atlas so it must be accessed from the B.C. Data Catalogue [@data_bc_digital_2021]. Scripts used for data acquisition and analysis associated with this paper are available on GitHub [@endicott_roadpaper_2024].

## Road Projection Methods

Our road projection methods focused on linking multiple target locations (also known as landings within harvest cutblocks (i.e., log decks)) to an existing road network by finding minimum-cost locations for new roadways that link landings within harvest cutblocks (i.e., log decks) to the existing road network, described by Dean [-@dean_finding_1997] as the multiple target access problem (MTAP). Specifically, we compared iterative least cost path (ILCP) and minimum spanning tree approaches (MST) proposed by Lochhead et al [-@lochhead_demo_2018; -@lochhead_linking_2022] for solving the MTAP to another iterative least cost path method developed by Hardy [-@hardy_forest_2019; -@hardy_landis-ii_2023] (Figure \@ref(fig:proj-meth-fig)). We used the QGIS version of Hardy’s method (2019), which was easier for us to apply and does not differ substantially from the LANDIS extension (Hardy, personal communication).

The ILCP approaches solve the MTAP by decomposing the problem into several smaller single target access problems (STAPs). For each landing (target location), the least cost path to the existing road network was solved using a mathematical graph and Dijkstra's shortest path algorithm [@dijkstra_note_1959]. There are a variety of possible methods for building graphs, choosing branch locations, and ordering target locations, and these different methods will produce different projected road networks [@anderson_projecting_2004; @hardy_forest_2019; @hardy_landis-ii_2023; @picard_finding_2006]. The ILCP algorithm we used [@lochhead_demo_2018; @lochhead_linking_2022] was parameterized with a weighted graph wherein each node corresponds to a raster pixel representing one of three components of the potential forest road network: a landing, a point on an existing road, or an intermediate point that is a plausible location for road construction. Each node was connected with up to eight neighbours, and the cost of construction along edges is either the average of the cost raster value at the source and destination nodes, or a more complex function of the difference in elevation between the source and destination nodes (Table \@ref(tab:cost-tbl), Supplement 1-1), which is then weighted by the distance to neighbouring nodes. Both the grade penalty and simple cost methods involve setting edge weights on a graph from adjacent locations on a single input grid; additional consideration of curvature and switchback spacing [@stuckelberger_improved_2007; @anderson_projecting_2004] would require additional computation. We use a greedy heuristic method that starts with the landing nearest to an existing road, builds a least cost path from the landing to the nearest (by Euclidean distance) point on the existing road, and updates the existing road network and weight raster with each new road segment before moving on to the next nearest landing.

The method described in Hardy et al. [-@hardy_forest_2019; -@hardy_landis-ii_2023] is similar to our simple cost ILCP method in that it breaks the MTAP down into many STAPs and finds the least cost path for each with the ordering of road construction determined by the Euclidean distance from the existing road network. A key difference is that Hardy uses the Dijkstra algorithm to solve a “single-source many-targets shortest path problem”, which is a special case of STAPs that finds the path between the landing cell and one of multiple potential connection points on the road network. In contrast, our algorithm first finds the closest point on the road network to the selected landing point and then uses the Dijkstra algorithm to solve the least cost path between the two. However, since the cost of construction on existing roads is zero we expect that in practice these two approaches are similar and the algorithm will select the least cost location for the road to connect to the existing road network. Within cutblocks, the Hardy et al. method iterates over each cell in the harvest area and builds a road if it is not within skidding distance of an existing road, while we create landing points to serve as target locations for road construction.

One of the limitations with ILCP methods is the sensitivity of the road projection to the ordering of the landings (Anderson and Nelson 2004). Minimum spanning trees (MST) offer an alternative approach to link landings and evaluate road branching opportunities [@picard_finding_2006; @clark_three-stage_2000]. MST algorithms do not require users to select the order in which landings are processed, but it remains necessary to select a set of points on the existing road network to include in the tree. As with the ILCP approach, the first step is to construct a graph in which each node is connected with up to eight neighbours, and set the cost of construction along edges using either the grade penalty or simple cost methods. This graph is used to estimate the least cost paths that link each of the landings and the least cost paths that link each landing to the nearest point on the existing road network. These results are used to create a second weighted graph where nodes are either landings or nearest points on the existing road network, and edge weights correspond to the total cost of the least cost path between pairs of nodes. The minimum spanning tree for this graph is solved using Kruskal's algorithm [@kruskal_shortest_1956], which links all nodes with a tree that minimizes the sum of edge weights. This method differs from Clark et al. [-@clark_three-stage_2000] who used Euclidean distances for edge weights, and thus did not incorporate spatial variation in road construction costs. 

```{=html}
<!--
TO DO: should this paragraph about speed and memory go in the results or discussion rather than methods?
-->
```
Note that the evolution of a road network over time can be modeled by iteratively applying any of the methods, but in this study we focus on comparing a single application of each of the methods to a network of forest roads developed since 1990.

To help make these road network projection methods more easily accessible, we implemented the ILCP and MST methods in the open source R package `roads` [@endicott_roads_2023]. The `roads` package depends on several other R packages including: `igraph` for calculating least cost paths and minimum spanning trees [@csardi_igraph_2006; @csardi_igraph_2024]; `terra` for manipulating spatial raster data [@hijmans_terra_2023]; and `sf` for manipulating spatial vector data [@pebesma_simple_2018; @pebesma_sf_2022]. We experimented with using graph construction methods in the package `gdistance` [@van_etten_r_2017], but opted to use Lochhead et al's [-@lochhead_demo_2018; -@lochhead_linking_2022] more computationally efficient methods (Supplement 1-7) by default. The package is available on CRAN (The Comprehensive R Archive Network) and the source code, tutorials and documentation are available on GitHub [@endicott_roads_2023].

## Comparison of Method Variants

The ILCP and MST methods connect landings within each cutblock to the existing road network, so an important first step is to select one or more landing locations in each block. We investigated the sensitivity of results to the pattern and density of landing locations by comparing results derived from the centroid of each cutblock to regular or randomly selected landing densities of 1 (low) and 10 (high) points per km^2^ (Figure \@ref(fig:proj-meth-fig)). We used default settings in the Hardy QGIS plugin except for skidding distance which was set to 200m. A skidding distance of 200 m corresponds to \~ 9 pts/km^2^. We compared two resolutions of the weight raster by aggregating the 1 ha resolution weight raster to a coarser 100 ha (1000 by 1000 m) resolution. In total, we compared 12 road projection method variants to a cutblocks only scenario with no projected roads (Table \@ref(tab:method-tbl)). We recorded compute time and peak RAM usage for each run, and ran some projections at 25 ha to show how speed and memory requirements vary with number of landings and number of nodes in the graph (Supplement 1-5), but did not assess other aspects of performance at that resolution.

## Performance Metrics

To assess performance we calculated four characteristics of the projected and observed road networks that are relevant for wildlife: road density, measured as density of roads in meters per hectare (m/ha); distance to nearest road, measured as distance from each raster cell to the nearest road; road disturbance footprint, measured with a 1 km buffer around roads [@ibisch_global_2016]; and forestry disturbance footprint, measured with a 500 m buffer around roads and cutblocks. The forestry disturbance footprint is a variant of the buffered anthropogenic disturbance metric that is used as an indicator of boreal caribou critical habitat [@johnson_science_2020] and to quantify impacts of disturbance on Southern Mountain caribou [@lochhead_linking_2022; @polfus_identifying_2011]. The other metrics are also often used in studies of anthropogenic impacts on wildlife [e.g. @labadie_global_2023; @stewart_climate-informed_2023; @apps_factors_2006; @apps_spatial_2013; @serrouya_time_2017]. We also calculated road presence, measured as whether or not roads are present in each pixel, but we note that accurate projection of the exact locations of forest roads is not generally a requirement in stochastic ecological forecasting models wherein the exact locations of future disturbances are often not known. Forestry disturbance footprint and road density were calculated using the *disturbanceMetrics* and *rasterizeLineDensity* functions in the `caribouMetrics` R package [@hughes_cariboumetrics_2022].

<!-- TO DO: Discuss why we do not calculate the 50m buffer metric used by Kyle for SMC. 50 m buffer is basically built in to the 100 m raster resolution. Road presence would be our closest equivalent measure - and we don't project that measure very well. -->

Aspatial performance of the projections was assessed by comparing projected and observed mean values of each road network characteristic across the timber supply area and within cutblocks. As an example, distance to roads within cutblocks is the average distance from non-road pixels within cutblocks to the nearest roads. Spatial performance was assessed in two different ways. First, difference maps were created by subtracting the projected distance to the nearest road from the observed in order to highlight discrepancies between the road networks. The observed and projected road networks were then overlaid on the difference maps and regions of major discrepancies were visaully investigated using Google satellite imagery in QGIS. Second, performance according to the three binary metrics (road presence, road disturbance footprint, and forestry disturbance footprint) was assessed by categorizing pixels of a projected raster into 5 categories compared with the observed raster: pre-existing footprint; agree roadless, meaning that both projected and observed show no footprint; agree roaded, meaning that both projected and observed show new footprint; false positive, meaning the projection shows a footprint but no footprint was observed; and false negative, meaning the projection shows no footprint but a footprint was observed. These categories were summarized for each projection and characteristic and used to calculate sensitivity, precision and F-measure of each metric [@lee_prediction_2021]. Sensitivity, also known as recall, gives the proportion of the true positives that were projected, while precision gives the proportion of positives projected that are true. Sensitivity will be lower when observed roads are missed and precision will be lower when roads are projected that were not observed. F-measure attempts to balance sensitivity and precision to give an overall score.

# Results

```{r get-data}
# load csv
meanTable <- read.csv(here(data_path_drvd,"../TSA27/dem", "mean_table.csv"))
matchData <- read.csv(here(data_path_drvd,"../TSA27/dem", "agree_table.csv"))
meanTableRealCuts <- read.csv(here(data_path_drvd,"../TSA27_real_cuts/dem",
                                   "mean_table.csv"))

matchDataRealCuts <- read.csv(here(data_path_drvd,"../TSA27_real_cuts/dem",
                                   "agree_table.csv"))

aspat_perf <- doAspatPlot(meanTableRealCuts)

perf_tbl <- doSpatPerf(matchDataRealCuts)
perf_tbl_rng <- perf_tbl %>% group_by(metric) %>% 
  summarise(rng_F = range(F_measure, na.rm = TRUE) %>% round(3) %>% paste0(collapse = " - "), .groups = "drop") %>% pull(rng_F, name = metric)

mst_reg_dens <- aspat_perf$prop_dif %>% 
  filter(metric == "Road\ndensity", sampleDens == "MST regular high density", 
         areaMean == "Overall")

mst_ran_dens <- aspat_perf$prop_dif %>% 
  filter(metric == "Road\ndensity", sampleDens == "MST random high density", 
         areaMean == "Cutblocks")

mst_out_dens <- aspat_perf$prop_dif %>% 
  filter(metric == "Road\ndensity", method == "mst", areaMean == "Outside\ncutblocks")

all_over_fordens <- aspat_perf$prop_dif %>% 
  filter(metric == "Forestry\ndisturbance\nfootprint", areaMean == "Overall")
```

According to all aspatial performance measures, the grade penalty method for setting edge weights yields better results than our simple cost methods (compare Figure \@ref(fig:aspat-perf-fig) and Figure S1). We therefore recommend using the grade penalty method, and focus on further examining variation in performance among grade penalty method variants (Figure \@ref(fig:aspat-perf-fig)). The MST regular high density method yields the best projections of road density overall (projected density: `r mst_reg_dens$response_proj %>% round(2)` m roads/ha, observed density: `r mst_reg_dens$response_obs %>% round(2)` m roads/ha), while the MST random high density method had the best projections within cutblocks (projected density: `r mst_ran_dens$response_proj %>% round(2)` m roads/ha, observed density: `r mst_ran_dens$response_obs %>% round(2)` m roads/ha), and all MST variants yield comparably good projections outside cutblocks (projected density: `r mst_out_dens$response_proj %>% range() %>% round(2) %>% paste0(collapse = " - ")` m roads/ha, observed density: `r mst_out_dens$response_obs %>% unique() %>% round(2)` m roads/ha). All MST variants yield better projections of the forestry disturbance footprint (projected: `r all_over_fordens %>% filter(method == "mst") %>% pull(response_proj) %>% range() %>% round(2) %>% unique()`, observed: `r all_over_fordens %>% filter(method == "mst") %>% pull(response_obs) %>% unique() %>% round(2)`) than the Hardy or ILCP methods (`r all_over_fordens %>% filter(sampleDens %in% c("Hardy QGIS", "ILCP regular high density")) %>% pull(response_proj) %>% round(2) %>% unique()`), and the Hardy and MST regular high density methods yield comparably accurate projections of road presence and distance to road.

Maps (Figures \@ref(fig:proj-meth-fig) and \@ref(fig:proj-map-fig)) help clarify exactly how the projection methods differ from one another, and from observed roads. While the Hardy et al. (2023) method and the grade penalty MST and ILCP methods project similar mean road densities within cutblocks, they create distinctly different road patterns within cutblocks. In particular, the grade penalty method incentivized roads to follow slope contours, while the Hardy method created more road curvatures (Figure \@ref(fig:proj-meth-fig)). Although the grade penalty method improved realism by following elevation contours, all these methods created dead ends, intersections, and abrupt turns that would be avoided in the engineering of operational roads in steep terrain (Figures \@ref(fig:proj-meth-fig) and \@ref(fig:proj-map-fig)c). All of the projected road methods also crossed valley bottoms far more often than observed roads which often run parallel to one another on each side of rivers (Figure \@ref(fig:proj-map-fig)a), but this discrepancy could likely be remedied by improved costs of crossing streams, rivers and other wet areas in valley bottoms. Finally, it is important to note that some discrepancies between observed and projected road networks were caused by errors in the observed data, such as cutblocks that were incorrectly classified (e.g. \@ref(fig:proj-map-fig)b). We omitted cutblocks with no associated access roads from our analysis, and note that failure to do this would distort results (Figures S3 and S4).

All of the road projection methods underestimate, road presence and forestry disturbance footprint (Figure \@ref(fig:aspat-perf-fig)). In other words, these road network projection methods project fewer roads than we observe. Projections of the forestry disturbance footprint, the road disturbance footprint, and, to a lesser extent, distance to road were more accurate than projections of road density and road presence (Figure \@ref(fig:aspat-perf-fig)), suggesting that these measures were more robust to our coarse assumptions about road projection. One reason for underestimation of road density is that all these methods generate straight road segments within a pixel. As raster resolution increases, the discrepancy within pixels between real roads and straight projected segments increases, which explains why projections of road density are less accurate when the raster resolution is coarse (Figure S6).

```{r, cache=TRUE}
# Example area for demonstrating different methods

library(dplyr)
library(sf)
library(roads)
library(terra)
library(tmap)
library(purrr)
library(caribouMetrics)
#library(pfocal)

# read in example area data
exRoads <- read_sf(here(data_path_drvd, "..", "testing_ex_roads.gpkg"))
tsb <- read_sf(here(data_path_drvd, "..", "testing_tsb.gpkg"))
cutblocks <- read_sf(here(data_path_drvd, "..", "testing_cutblocks.gpkg"))
tsaCost <- raster::raster(here(data_path_drvd, "..", "testing_cost.tif"))
dem <- raster::raster(here(data_path_drvd, "..", "testing_dem.tif"))
roads <- read_sf(here(data_path_drvd, "..", "testing_obs_roads.gpkg"))

# densities
high <- 0.00001
low <-  0.000001

sampleDens <- c(high, high, low)
sampleType <- c("regular","random","centroid")
paramTable <- tibble(sampleType, sampleDens,
                     method = "mst",
                     runTime = vector("list", length(sampleDens)),
                     output = vector("list", length(sampleDens)),
                     roadDisturbance = vector("list", length(sampleDens)),
                     roadDensity = vector("list", length(sampleDens)),
                     roadPresence = vector("list", length(sampleDens)),
                     distanceToRoad = vector("list", length(sampleDens)),
                     forestryDisturbance = vector("list", length(sampleDens))) %>%
  distinct()

simpleCostFn = function(x1,x2,hdistance,...) hdistance*(x1+x2)/2
paramTable$weightFunction = deparse1(simpleCostFn,collapse="\n")
paramTable$weightMethod = "simple cost"

paramTableDem = paramTable
paramTableDem$weightFunction = deparse1(gradePenaltyFn,collapse="\n")
paramTableDem$weightFunction = gsub("limitWeight = NA","limitWeight = 65000",paramTableDem$weightFunction,fixed=T)
paramTableDem$weightMethod = "grade penalty"

paramTableDem<- subset(paramTableDem,sampleType!="centroid")

if(rerun){
  # re-run projections for just the small area with different parameters
set.seed(4)
mstProj <- projectAll(tsbs = tsb, paramTable = paramTable,
                      weightRaster = tsaCost,
                      cutblocks = cutblocks,
                      existingRoads = exRoads,
                      fileLocation = here(data_path_drvd,"..", "for_fig"),
                      roadsInWeight = F)
set.seed(4)
ilcpProj <- projectAll(tsbs = tsb,
                       paramTable = paramTable %>%
                         filter(sampleType == "regular") %>%
                         mutate(method = "ilcp"),
                       weightRaster = tsaCost,
                       cutblocks = cutblocks,
                       existingRoads = exRoads,
                       fileLocation = here(data_path_drvd,"..", "for_fig"),
                       roadsInWeight = F)

# re-run projections for just the small area with different parameters
set.seed(4)
mstProjDem <- projectAll(tsbs = tsb, paramTable = paramTableDem,
                         weightRaster = dem,
                         cutblocks = cutblocks,
                         existingRoads = exRoads,
                         fileLocation = here(data_path_drvd,"..", "for_fig"),
                         roadsInWeight = F)
set.seed(4)
ilcpProjDem <- projectAll(tsbs = tsb,
                          paramTable = paramTableDem %>%
                            filter(sampleType == "regular") %>%
                            mutate(method = "ilcp"),
                          weightRaster = dem,
                          cutblocks = cutblocks,
                          existingRoads = exRoads,
                          fileLocation = here(data_path_drvd,"..", "for_fig"),
                          roadsInWeight = F)

terra::writeRaster(tsaCost, here(data_path_drvd,"..",  "for_fig","HardyQGISTestweight.tif"),overwrite=T)

allProj <- bind_rows(mstProj, ilcpProj, mstProjDem, ilcpProjDem) %>%
  arrange(weightMethod,desc(sampleType), sampleDens)

# add Hardy QGIS results for the same area

allProj <- bind_rows(
  allProj,
  tibble(sampleType = "", sampleDens = 0, method = "Hardy QGIS",
         output = list(here(data_path_drvd,"..", "for_fig",
                            "HardyQGISTest.gpkg")))) %>%
  mutate(mapTitle =  paste(ifelse(is.na(weightMethod), "", weightMethod),
                           ifelse(method == "mst", "MST",
                                  ifelse(method == "ilcp", "ILCP", method)),
                           sampleType) %>%
           trimws())

# add extra row for legend
allProj <- bind_rows(allProj,
                     slice(allProj, 1))

saveRDS(allProj, here("analysis/data/derived_data/test_prog_fig3.rds"))

} else {
  allProj <- readRDS(here("analysis/data/derived_data/test_prog_fig3.rds"))
}


allMaps <- purrr::map(
  1:nrow(allProj),
  ~ qtm(cutblocks, borders = "#92c5de", fill="#92c5de", borders.lwd = 1,)+
    qtm(rast(here(gsub(".gpkg","weight.tif",allProj$output[[.x]],fixed=T))),
        raster.style = "cont", raster.palette = "Greys",
        raster.alpha = 0.25, raster.title = NA, raster.legend.show = FALSE)+
    qtm(roads, lines.col = "#0571b0", lines.lwd = 2,lines.lty="solid")+
    qtm(read_sf(here(allProj$output[[.x]])), lines.col = "#ca0020", lines.lwd = 2)+
    qtm(exRoads, lines.col = "black", lines.lwd = 2)+
    tm_layout(legend.show = .x == nrow(allProj),
              legend.only = .x == nrow(allProj),
              main.title = allProj$mapTitle[[.x]],
              main.title.size = 0.75))

allMaps[[nrow(allProj)]] <- allMaps[[nrow(allProj)]]+
  tm_add_legend(type = "fill",
                labels = c("low", "med", "high"),
                col = c("grey99", "grey87", "grey75"),
                border.col= c("grey99", "grey87", "grey75"),
                title = "weightRaster")+
  tm_add_legend(type = "line",
                labels = c("Existing roads", "Projected roads", "Observed roads"),
                col = c("black", "#ca0020", "#0571b0"),lty=c("solid","solid","solid"))+
  tm_add_legend(type = "fill",
                labels = "Cutblocks",
                col = "#92c5de", border.col ="#92c5de")+
  tm_layout(legend.only = TRUE, legend.position = c("center", "center"))

tmap_save(tmap_arrange(allMaps, ncol = 3),
          here("analysis/figures/projection_methods_figure.tiff"),
          dpi = knitr::opts_chunk$get("dpi"), compression="lzw", 
          height = 8, width = fig_widths["two"])
```

```{r speed-fig}
# Get run times from bench marking results
# compile results after running on cloud
bench_res <- list.files(here::here("analysis/data/derived_data/bench_results"),
                        pattern = "bench_.*.rds",
                        full.names = TRUE) %>%
  purrr::map(readRDS) %>%
  bind_rows() %>%
  tidyr::separate(id, into = c("method", "sampleType", "sampleDens", "agg", "cutblocks_real"),
                  sep = "_",
                  extra = "merge", convert = TRUE)

# Hardy time measured in QGIS with 100m raster
hardy_time <- 2*60+34

ilcp_time <- bench_res %>% 
  filter(method == "ilcp", cutblocks_real == "revelstoke_real",
         resolution == 100) %>% 
  pull(Elapsed_Time_sec) %>% units::set_units("sec") %>%
  units::set_units("hours") %>% round(2) %>% units::drop_units()

mst_time <- bench_res %>% 
  filter(method == "mst", cutblocks_real == "revelstoke_real",
         resolution == 100, sampleDens == 1e-05, sampleType == "regular") %>% 
  pull(Elapsed_Time_sec) %>% units::set_units("sec") %>%
  units::set_units("hours") %>% round(2) %>% units::drop_units()

```

Although these methods underestimate road presence, they represent a substantial improvement over the "cutblocks only" scenario, which assumes no new roads are built (Figure \@ref(fig:aspat-perf-fig)). These relatively coarse methods were not designed to project the exact spatial location of new roads (within 100 m), so it is not surprising that they did not yield accurate spatial projections of road presence (F-Measure: `r perf_tbl_rng["Road presence"]`). On the other hand, none of the methods provide better information about the exact location of the forestry disturbance footprint than the locations of cutblocks only (F-Measure: `r perf_tbl_rng["Forestry disturbance\nfootprint"]`). This is likely because many of the projected roads are within 500 m of either the existing road network or a cutblock so the false negatives created by failing to project roads are balanced by the lack of false positives. All methods other than "cutblocks only" provided comparably good projections of the road disturbance footprint (F-Measure: `r perf_tbl_rng["Road disturbance\nfootprint"]`), though higher sampling densities yielded fewer false negatives and more false positives (Figure \@ref(fig:spat-perf-fig)).

Although the MST method performed better than the alternatives we tested according to several important wildlife habitat metrics (Figure \@ref(fig:aspat-perf-fig)), it requires greater computation resources for large landscapes (Figure S7). All of these methods require construction of a mathematical graph with a node for each pixel in the weight raster where road construction is possible (i.e. not NA), and memory requirements increase with the number of nodes in the graph (Figure S7). Compute time also increases with the number of landing targets (Figure S7). Lochhead et al's [-@lochhead_demo_2018; -@lochhead_linking_2022] method of graph construction is more computationally efficient than the adjacency matrix approach used in the R package `gdistance` [@van_etten_r_2017] (Figure S8), in part because it avoids the additional cost of constructing a transition matrix, and in part because it ignores variation in the size of raster cells that is accounted for in the `gdistance` *geoCorrection* function. For our example landscape the Hardy QGIS plugin was 65 times faster than the MST and ILCP methods implemented in R (Figure S7).

# Discussion

Despite a rapidly growing body of evidence of complex and varied impacts of road networks on wildlife and other values, and increasing use of spatial stochastic models for forecasting impacts of forest disturbance across regions, very few spatial stochastic projections of forest disturbance dynamics have included road network projections, in part because tools suited for this purpose have not been available. Hardy et al. [-@hardy_forest_2019; -@hardy_landis-ii_2023] partially addressed this need with an extension that can be integrated with other components of the LANDIS-II modelling framework [e.g. @labadie_global_2023]. Our implementations of iterative least cost path and minimum spanning tree methods [@lochhead_demo_2018; @lochhead_linking_2022] in the open source R package `roads` [@endicott_roads_2023] provide an alternative to Hardy's method that improved predicted road patterns in our example landscape, and can be easily integrated into R workflows and modelling frameworks used for forecasting forest change in Canada and elsewhere [e.g. @barros_empowering_2023; @daniel_state-and-transition_2016]. Although projecting roads within a stochastic ecological forecasting model was beyond the scope of this study, our analysis of performance using metrics relevant to wildlife can help guide method selection in that context.

We evaluated performance of forest road network projection algorithms in a topographically complex region of British Columbia where we anticipated projection would be challenging, and implemented a simplified version of Anderson and Nelson’s (2004) grade penalty method for setting graph edge weights that improves performance in this mountainous region. The simplified grade penalty method does not substantially increase memory or computational requirements, and requires only a few additional lines of code to implement (Supplement 1-1). We found advantages to this approach in regions where slope is an important determinant of road construction cost, and we recommend its use. However, we also acknowledge that we have used a very simple cost model, and that the important determinants of road construction costs may vary among landscapes. We have therefore also allowed the possibility for users of the `roads` R package to specify their own method for determining edge weights from adjacent node values in a weight function. A more complex cost model could include variation among substrate types (e.g. peat, clay, gravel) and more nuanced consideration of the costs of various types of water crossings (e.g. culverts and bridges). Road construction costs and wildlife impacts also vary substantially among types of roads (e.g. long-term vs temporary haul roads). If distinguishing among types of roads is important, an effective approach might be to first project the paths of lengthy long-term haul roads using a cost model and a set of targets that are appropriate for this type of road, and then project the paths of shorter temporary haul roads or spur roads from this long-term network using a different cost model and set of landing locations.

Among the method variants we considered, the minimum spanning tree (MST) regular high landing density method yielded the best projections of average road density and forestry disturbance footprint (Figure \@ref(fig:aspat-perf-fig)). Aspatial summaries of road presence, distance to road, and road disturbance footprint were comparable to Hardy's method [-@hardy_landis-ii_2023] (Figure \@ref(fig:aspat-perf-fig)). However, the MST algorithm was also more computationally demanding than the other methods we tested (Figure S7), so users will need to consider whether the benefits of improved performance outweigh the increased computational costs in their particular circumstance.

Aspatial metrics of overall projection accuracy can be difficult to interpret. To more deeply understand variation in the behaviour of road network projection algorithms we found it helpful to distinguish between performance within cutblocks and outside of them, and to examine spatial patterns. This examination highlighted some errors that could be fixed by better accounting for the cost of water crossings in our weight raster, and other more fundamental limitations and differences among methods. Even in cases where the Hardy and grade penalty methods project similar mean road densities, the projected pattern of roads within cutblocks is quite different, in that the grade penalty roads tend to follow elevation contours, while Hardy et al's method produces curves (Figure \@ref(fig:proj-meth-fig)). We suspect the latter behaviour is an artifact of searching for nearest destinations \>200 m away on a 100 m grid.

Although the grade penalty method improves performance by aligning roads with elevation contours, all these methods create dead ends, intersections, and abrupt turns that are avoided in real road networks. We chose not to implement Anderson and Nelson's methods (2004) for penalizing sharp curves, large junction angles and switchback spacing because these complications would increase algorithmic complexity and computational costs. Simple algorithms can recreate some aspects of observed road networks but not others, and more complex realistic algorithms are generally more costly to develop and use. Before investing in additional complexity, it is important to recognize that adequacy depends on the goal. For some purposes, projections from relatively crude cost models and simple algorithms may be adequate. For example, models of caribou movement often include distance to roads as a predictor [e.g. @labadie_global_2023], and a combined metric of buffered anthropogenic disturbance best explains variation in boreal caribou demographic rates among ranges [@johnson_science_2020]. In our example landscape, projections of the disturbance footprints (500 m and 1km buffer) and distance to road are reasonably accurate, and for wildlife response models informed by these measures our somewhat crude road projections are likely good enough. On the other hand, these methods do not predict the exact spatial locations of roads, so outcomes and impacts should not be reported or interpreted at the level of individual pixels; for example, these projections should not guide selection of sample locations for studies of the local (pixel level) impacts of anticipated roads.

Examination of spatial mismatch between observed and projected roads also highlighted errors in our input data. We note these errors because they are not unique to our study area; there is considerable variation in the consistency and accuracy of available resource road information across Canada and elsewhere [@poley_identifying_2022; @british_columbia_ministry_of_forests_lands_natural_resource_operations_and_rural_development_resource_nodate] that users should keep in mind interpreting discrepancies between observed and projected road networks.

These road projection methods require construction of large graphs, with a node for each pixel in which road construction is possible. In our example landscape we were able to project at 100 m resolution in a reasonable amount of time (\< 2.4 hours) using modest amounts of memory (\<3 GB RAM). However, our example landscape is fairly small, and memory requirements increase rapidly with landscape size (Supplement 1-5). Although it is possible to use machines with more RAM, the computational cost of adding road projections to spatial stochastic simulations of forest change relevant for wide-ranging wildlife is not trivial. For example, in a study of the effects of forest management and climate change scenarios on wildlife in a single boreal caribou range (100 stochastic realizations of 6 scenarios), we projected roads at 50 m resolution using graph with ~21 million nodes. Each ILCP road projection required 2.7 hours and 11 GB of RAM, for a total of 1620 compute hours.

Options for reducing computational requirements include restricting the area where road construction is possible (by setting some portions of the weight raster to NA), reducing landing density within cutblocks (by using the centroid method), increasing raster resolution, or using Hardy's more efficient implementations. The first three options are available to users of the `roads` R package. However, those contemplating reducing computational cost by decreasing raster resolution should be cautious of the results given that all of these methods become less accurate as raster cell size increases (Figures S5 and S6). The distance to road metric is less sensitive to changes in cell resolution, and distance metrics may also be more ecologically meaningful [@rowland_elk_2000]. Those considering reducing computational cost by reducing landing density within cutblocks should be clear that their projected road network will be incomplete and metrics such as total road length and road density will be underestimated. More involved possibilities for reducing computational costs include adopting faster routing algorithms [@larmet_cppRouting_2022], implementing slow components of the R package (Figure S8) in a faster compiled language, parallel processing, and implementing a multi-scale approach in which coarse resolution results are used to limit the area considered in finer resolution projections. Several of these options have been implemented in the `cppRouting` R package [@larmet_cppRouting_2022], and future versions of the `roads` R package could borrow and build on `cppRouting` functionality.

There are many metrics of connectivity and fragmentation [@francis_routledge_2021] we did not consider in this paper. In general, performance will vary among metrics, and it is difficult to determine what is good enough without reference to particular circumstances (i.e. objectives, species, landscapes). For example, if the outcome of interest is space use or connectivity projected from more [e.g. @whittington_towns_2022; @labadie_global_2023] or less [e.g. @diniz_landscape_2020; @hughes_comparison_2023] species-specific movement models it may be helpful to test sensitivity to the difference between observed and retrospectively projected roads to confirm that projections are adequate for the intended purpose. When constructing new wildlife response models intended for projection, it may also be helpful to select metrics such as distance to road or buffered disturbance footprint that are more easily projectable [@bodner_bridging_2021]. Rather than testing additional performance metrics, we have focused our efforts on the development of an open source R package [@endicott_roads_2023] and workflows [@endicott_roadpaper_2024] that enable users to devise performance tests appropriate to their particular circumstances and goals. We recognize that acquiring data to retrospectively project roads can be challenging, so we also provide output maps [@endicott_assessment_2024] and an example script (analysis/scripts/4_calc_any_metric.R) to enable calculation of alternative performance metrics of interest for our Revelstoke example, along with a data preparation script (analysis/scripts/1_prepareData.R) that could be modified to extract required input data for other areas in British Columbia [@endicott_roadpaper_2024].

In this study our focus was developing tools capable of integrating forest road development into projections of the cumulative effects of disturbance on wildlife. However, we note there are other possible uses for our road network projection methods. Cost minimizing methods are not suitable for projecting development of seismic lines (e.g. Figure S9), but for other circumstances such as mine access where the objective is to minimize the cost of reaching a target location these methods may be applicable. Lochhead et al. [-@lochhead_linking_2022] used the least cost path algorithm to reconstruct the likely history of road network development in a case where harvest dates were known but road construction dates were not. It would also be interesting to account for persistent impacts of resource roads on vegetation, productivity and carbon sequestration [@braham_characterization_2023].

# Conclusion

TODO In conclusion we found coarse road projection methods can accurately project some disturbance metrics. We recommend a high density of landings, a grade penalty in the cost surface and our MST algorithm for ordering landings with iterative least cost paths approaches. ……

```{=html}
<!-- The model will simply build the roads in the least costly locations based on the cost surface, however often in the real world, roads must be planned around ownership and administrative boundaries. In BC, forestry roads are developed by forest licensees under a timber harvesting permit (Government of British Columbia, 2021c). -->

Discuss challenges on large landscapes & solutions...
```
# Acknowledgements

This work was motivated by discussions with Colin Daniel (Apex Resource Management Solutions) and needs of the Western Boreal Initiative, an effort to project cumulative effects of disturbances on forests and wildlife led by Eliot McIntire (Canadian Forest Service, Natural Resources Canada) and Samuel Haché (Canadian Wildlife Service, Environment and Climate Change Canada). Questions from Steve Cumming (Université Laval) and Lisa Venier (Canadian Forest Service, Natural Resources Canada) helped refine our focus and approach. We thank Clément Hardy for answering our questions about his method.

# Competing interests

The authors declare there are no competing interests.

# Author Contributions

Conceptualization: JH, SE, DL, GP, KL Data curation: SE, DL Formal analysis: JH, SE, DL Funding acquisition: JH Investigation: JH, SE Methodology: JH, SE, DL, KL Project administration: JH Resources: JH Software: JH, SE, KL Supervision: JH Visualization: SE Writing – original draft: JH, SE, DL Writing – review & editing: JH, SE, DL, GP, KL

# Funding

Funding for this work was provided by Environment and Climate Change Canada.

# Data availability

Data generated or analyzed during this study are available in the Open Science Framework repository, <https://osf.io/8vmqh/?view_only=d168967961914f22af89e44c19aec019>. The code to reproduce the analysis and figures in this paper is available on GitHub at <https://github.com/LandSciTech/RoadPaper>. The `roads` package can be installed from CRAN and the code and a user guide are available on GitHub at <https://github.com/LandSciTech/roads>.

<!-- The following line inserts a page break  -->

\newpage

# Literature Cited

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::

\newpage

# Supplementary Material

*Supplement 1.* Detailed methods and additional results and figures, including: detailed methods for the grade penalty function; results using simple cost, all cutblocks, and a coarse resolution raster; projection method benchmarking and profiling; and a map of roads in Fort Nelson timber supply area.

\newpage

# Figures

Figure 1: Road construction cost surface and an elevation surface used to calculate grade penalties. Costs are calculated using a simple model informed by slope and major barriers (Table 1, Supplement 1-1) in the Revelstoke timber supply area in British Colombia, Canada. In both layers, pixels containing existing roads are assigned a value of 0.

Alt text: Two raster maps of Revelstoke timber supply area in grey scale, with an inset map showing the location of the study area within Canada.  

```{r study-area, fig.cap="."}

knitr::include_graphics(here("analysis/figures/Figure1_StudyArea_both.tiff"))
```

\newpage

Figure 2: Proportional difference of projected mean from observed mean road metrics using different projection method variants within cutblocks, outside cutblocks, and overall (1 ha weight raster). Values greater than zero indicate overprojection and negative values indicate underprojection. Cutblocks not accessible via the observed road network were excluded from analysis. Performance varies among metrics (columns), projection method variants (colours), and within and outside cutblocks. Projection method variants are defined in Table 2. Note that extreme values for the cutblocks only method within cutblocks are cut off to ensure patterns in the other methods to remain visible. Bars that are cutoff are labeled with the total value. 
Alt text: A faceted bar chart with one bar for each projection method variant and a panel for each combination of performance metrics and within cutblock, outside cutblock and overall. 

```{r aspat-perf-fig, fig.height=4, fig.width=fig_widths["two"], out.width=paste0(fig_widths["two"], "in"), out.height="4in", fig.cap="."}
# organize data for ggplot
# need to make plots more comparable
# Other option is setting limits but want to avoid excess white space
ann_plus <- aspat_perf$prop_dif %>% 
  filter(abs(prop_dif) > 0.5) %>% 
  mutate(lab = round(prop_dif, 2), 
         prop_dif = 0.37*sign(prop_dif))

aspat_perf$plt+coord_flip(ylim = c(-0.35, 0.35))+
  geom_text(aes(label = lab), data = ann_plus, hjust = "inward", vjust = 0.5,
            size = 8, size.unit = "pt")
```

\newpage

Figure 3: Comparison of road projection method variants (Table 2). The large four sided cutblock in the top right was added to more clearly show algorithm behaviour within cutblocks.The grade penalty method for setting edge weights (top row) encourages roads to follow slope contours, and yields fewer obviously unrealistic 90 degree turns in steep terrain than our simple cost method (middle row). Selecting a single landing at the centroid of each cutblock (bottom left) creates too few roads within cutblocks. In this 1 ha resolution example the Hardy QGIS plugin (bottom middle) creates more curved roads than our simple cost method (middle row), and does not follow slope contours like the grade penalty method (top row). Landing density is high for all except the centroid and Hardy variants.

Alt text: A series of 8 maps showing roads projected with different method variants. 

```{r proj-meth-fig, out.width=paste0(fig_widths["two"], "in"), out.height="8in", fig.cap="."}
knitr::include_graphics(here("analysis/figures/projection_methods_figure.tiff"),
                        dpi = knitr::opts_chunk$get("dpi"))
```

\newpage

Figure 4: Comparison of the minimum spanning tree projection with regular high density sampling to the observed road network. The main map shows observed distance to the nearest road minus the projected distance. Insets highlight areas of interest with satellite imagery (Google 2022) for context: (a) Projected and observed road networks follow valleys but projected roads cross valley bottoms more frequently; (b) some open areas are misidentified as cutblocks; (c) projected roads follow contours but do not avoid turns and dead ends like observed switchbacks.

Alt text: A raster map of the Revelstoke TSA where the colour indicates the difference between obeserve and projected distance to road. Three inset maps zoom in of specific areas with Google satelite imagery in the background.
```{r proj-map-fig, fig.height=9, fig.width=fig_widths["two"], fig.cap="."}

knitr::include_graphics(here("analysis/figures/Figure4_map_update.tif"))

```

\newpage

Figure 5: Variation in spatial performance among projection method variants (1 ha weight raster). F-measure is the harmonic mean of precision and sensitivity, precision is the proportion of predicted pixels that were observed and sensitivity is the proportion of observed pixels that were correctly predicted. Values closer to one indicate better performance. Cutblocks not accessible via the observed road network were excluded from analysis. Projection method variants are defined in Table 2.

Alt text: A faceted bar chart with one bar for each projection method variant and a panel for each combination of binary performance metrics and within cutblock, outside cutblock and overall.
```{r spat-perf-fig, fig.height=4.5, fig.width=fig_widths["two"], out.width=paste0(fig_widths["two"], "in"), out.height="4.5in", fig.cap="."}

doSpatPlot(perf_tbl)

```

\newpage

# Tables

Table 1: Road construction costs. In the “grade penalty” method, we assign grades \>20% a more prohibitive cost of 65000, which is also assigned to major water bodies. These barriers are not set to NA because roads must cross barriers to reach a few isolated cutblocks in our example landscape.

```{r cost-tbl}
tbl <- "Cost Type|Value ($ per km)|Source
Slope (%)|16178 + 504*slope|Interior appraisal manual
Major lakes|65000|Major water bodies of BC
Existing roads|0|Digital road atlas and forest tenure roads for BC
"
df <- read.delim(textConnection(tbl),header=FALSE,sep="|",strip.white=TRUE,stringsAsFactors=FALSE)
names(df) <- unname(as.list(df[1,]))
df <- df[-1,] # remove first row
row.names(df)<-NULL
knitr::kable(df, caption = ".")
```

\newpage

Table 2: Road projection method variants. We examined sensitivity of minimum spanning tree (MST) and iterative least cost path (ILCP) algorithms to the method of setting edge weights (grade penalty or simple cost), the placement of landings within cutblocks (regular or random), the density of landings within cutblocks, and map resolution.

```{r method-tbl}
tbl2 <- "Projection method|Sample type|Sample density (pts/km^2^)|Resolutions
MST grade penalty & simple cost|Regular|1|1 & 100 ha
MST grade penalty & simple cost|Regular|10|1 & 100 ha
MST grade penalty & simple cost|Random|1|1 & 100 ha
MST grade penalty & simple cost|Random|10|1 & 100 ha
MST grade penalty & simple cost|Centroid|N/A|1 & 100 ha
ILCP grade penalty & simple cost|Regular|10|1 ha 
Hardy QGIS|N/A|~9|1 ha
Cutblocks only|N/A|N/A|1 ha

"
df2 <- read.delim(textConnection(tbl2),header=FALSE,sep="|",strip.white=TRUE,stringsAsFactors=FALSE)
names(df2) <- unname(as.list(df2[1,]))
df2 <- df2[-1,] # remove first row
row.names(df2)<-NULL
knitr::kable(df2, caption = ".")
```

\newpage

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies:

```{r colophon, cache = FALSE}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
